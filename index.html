<!DOCTYPE html>
<html lang="tr">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LCE4Z60ZB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7LCE4Z60ZB');
  </script>
  <link rel="icon" href="/assets/logo.svg" type="image/svg+xml">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>simscent — Ana Sayfa</title>
  <meta name="description" content="Benzersiz tercihlerinle eşleşen parfümleri keşfet. Hazır koleksiyonumuzu incele ve sana en uygun eşleşmeyi bul."/>
  <meta name="google-adsense-account" content="ca-pub-9033780165680589">
  <link rel="canonical" href="https://www.simscent.com/"/>

  <!-- Favicon / app icons -->
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/assets/favicon-32.png" sizes="32x32" type="image/png">

  <!-- Fonts & icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,500..700,0..1,-50..200"/>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <style>
    :root{
      --brand-primary:#B99B6B;--brand-secondary:#A08C62;--text:#3a3a3a;--muted:#888;--border:#eee;--card:#fff;--shell:#f9f8f6;
      --elev-1:0 4px 15px rgba(0,0,0,.05);--elev-2:0 8px 30px rgba(0,0,0,.07);--elev-3:0 12px 40px rgba(0,0,0,.1)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:var(--text);line-height:1.6;background:var(--shell)}
    body::before{content:"";position:fixed;inset:0;background-image:radial-gradient(hsla(0,0%,82%,.2) 1px,transparent 1px);background-size:20px 20px;opacity:.35;pointer-events:none}

    .material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;display:inline-flex;align-items:center;vertical-align:-3px;font-size:18px;line-height:1}

    .landing{max-width:1200px;margin:28px auto;padding:16px}
    @media(min-width:768px){.landing{padding:28px}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:24px;box-shadow:var(--elev-2);overflow:hidden;position:relative}
    .card-inner{padding:24px 16px}
    @media(min-width:768px){.card-inner{padding:32px}}
    @media(min-width:1024px){.card-inner{padding:40px}}

    .top{display:flex;align-items:center;justify-content:space-between;padding-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;font-size:22px;letter-spacing:-.02em;font-family:'Playfair Display',serif;cursor:pointer}
    .logo{width:32px;height:32px;display:block;background:transparent;border:none;box-shadow:none;border-radius:0}

    .cta{border:none;border-radius:8px;padding:10px 20px;font-weight:700;font-size:15px;color:#fff;background:var(--text);cursor:pointer}

    .hero{display:grid;grid-template-columns:1fr;gap:40px;align-items:center;margin-top:20px}
    @media(min-width:980px){.hero{grid-template-columns:420px 1fr;gap:60px}}
    .shot-wrap{position:relative}
    .blob,.blob2{position:absolute;border-radius:28px}
    .blob{width:120px;height:120px;background:rgba(185,155,107,.15);left:-18px;top:-16px;opacity:.8}
    .blob2{width:130px;height:130px;background:rgba(185,155,107,.1);left:220px;bottom:-10px;opacity:.6}

    .shot{
      width:100%;aspect-ratio:1/1;object-fit:cover;padding:16px;background:#fff;border:1px solid var(--border);
      border-radius:28px;transform:rotate(-6deg);box-shadow:0 28px 70px rgba(0,0,0,.15)
    }

    .title{font-family:'Playfair Display',serif;font-size:clamp(38px,5.6vw,60px);font-weight:800;letter-spacing:-.04em;line-height:1.05;color:#222;margin-bottom:16px}
    .desc{color:var(--muted);max-width:760px;font-size:17px}

    .search-wrap{margin:28px 0 12px;max-width:760px;position:relative;z-index:60}
    .searchbar{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:12px 16px;box-shadow:var(--elev-1)}
    .searchbar input{flex:1;border:none;background:transparent;outline:none;font-size:16px;color:var(--text);caret-color:var(--text)}
    .searchbar input::placeholder{color:#aaa}
    .icon-btn{width:44px;height:44px;border-radius:999px;border:none;display:grid;place-items:center;background:var(--text);color:#fff;cursor:pointer}

    .actions{display:flex;flex-wrap:wrap;gap:14px;margin-top:20px}
    .btn{border:none;border-radius:8px;padding:14px 22px;font-weight:700;font-size:15px;cursor:pointer;transition:all .2s}
    .btn.primary{background:var(--text);color:#fff}.btn.primary:hover{background:#000}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}.btn.ghost:hover{border-color:#ccc;background:#fafafa}

    .suggest{display:none;position:absolute;left:0;right:0;top:100%;margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--elev-2);max-height:320px;overflow:auto;text-align:left;color:var(--text);z-index:70}
    .s-item{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer}
    .suggest .s-item:hover,.s-item:hover{background:inherit!important;color:inherit!important;box-shadow:none!important;filter:none!important}
    .s-thumb{width:34px;height:34px;border-radius:9px;object-fit:cover;background:#e2e8f0;flex-shrink:0}
    .s-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .s-brand{color:var(--muted)!important;font-size:13px;margin-left:auto}

    .section{padding:32px 0;border-top:1px dashed #e5e7eb}
    @media(min-width:768px){.section{padding:48px 0}}

    /* Prefs */
    #prefs .pref-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:12px 16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;min-height:48px;border:1px solid #f1f5f9;border-radius:14px;background:#fff}
    .lbl{font-size:16px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    @media(min-width:768px){.lbl{font-size:18px}}
    .toggle{position:relative;width:44px;height:26px;background:#e2e8f0;border-radius:999px;transition:background .25s ease;cursor:pointer;flex-shrink:0}
    .toggle .dot{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:999px;background:#fff;box-shadow:0 2px 6px rgba(2,6,23,.15);transition:transform .25s ease}
    .toggle.active{background:var(--brand-primary)}
    .toggle.active .dot{transform:translateX(18px)}

    .pf{display:flex;flex-direction:column;gap:12px;border-radius:18px;padding:12px;border:1px solid transparent;box-shadow:var(--elev-1);background:#fff;transition:box-shadow .28s cubic-bezier(.25,.8,.25,1),transform .28s cubic-bezier(.25,.8,.25,1),border-color .28s;overflow:hidden}
    .pf:hover{transform:translate3d(0,-6px,0);box-shadow:var(--elev-3);border-color:rgba(185,155,107,.35)}
    .pf-img{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#e2e8f0;margin:0}
    .pf-brand{font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:var(--brand-primary);font-weight:700}
    .pf-name{font-family:'Playfair Display',serif;font-size:18px;line-height:1.25;font-weight:700}
    .badge{background:var(--brand-primary);color:#fff;padding:6px 14px;border-radius:999px;font-size:12px;font-weight:700;margin-left:auto;white-space:nowrap}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--shell);padding:6px 12px;border-radius:999px;font-size:13px;font-weight:600;color:var(--text)}
    .chip.small{font-size:12px;padding:4px 10px}

    .prefs-head{position:sticky;top:8px;z-index:5;background:linear-gradient(0deg,var(--shell),var(--shell));padding-bottom:8px;margin-bottom:12px}
    .prefs-head-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .prefs-actions{display:flex;align-items:center;gap:10px}
    .link-reset{appearance:none;background:transparent;border:none;color:var(--brand-secondary);font-weight:700;cursor:pointer}
    .link-reset:hover{text-decoration:underline}
    .collapse-btn{appearance:none;border:1px solid var(--border);background:#fff;width:34px;height:34px;border-radius:999px;display:grid;place-items:center;cursor:pointer}
    @media(min-width:768px){.collapse-btn{display:none}}

    /* Collapse behavior (mobile) */
    #upload-section.collapsed #prefs{display:none}

    .scores{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
    @media(min-width:480px){.scores{grid-template-columns:repeat(4,1fr)}}
    .ring{position:relative;width:54px;height:54px;margin:0 auto 6px}
    .svg{width:54px;height:54px;transform:rotate(-90deg)}
    .bg{fill:none;stroke:#eef2f7;stroke-width:6}
    .fg{fill:none;stroke:var(--brand-primary);stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .6s}
    .val{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:13px}

    .ref-card-grid{display:grid;grid-template-columns:1fr;gap:28px;align-items:start}
    @media(min-width:920px){.ref-card-grid{grid-template-columns:300px 1fr;gap:40px}}
    .ref-card-image{width:100%;max-width:300px;margin:0 auto;aspect-ratio:1/1;border-radius:20px;object-fit:cover}
    .ref-card-title{font-family:'Playfair Display',serif;font-size:clamp(26px,4vw,34px);font-weight:700;line-height:1.2;color:#222;margin:0}
    .ref-card-sub{color:var(--muted);font-size:15px;margin-top:8px;margin-bottom:28px}
    .detail-section{padding-top:20px;margin-top:20px;border-top:1px solid var(--shell)}
    .detail-section:first-of-type{margin-top:0;padding-top:0;border-top:0}
    .detail-section-title{font-size:14px;font-weight:700;margin-bottom:12px;color:var(--text);text-transform:uppercase;letter-spacing:.8px;opacity:.8}

    .carousel-container{position:relative}
    .carousel-window{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:16px}
    .carousel-window::-webkit-scrollbar{display:none}
    .carousel-window>.pf{flex:0 0 70%;scroll-snap-align:start;margin:10px 16px 10px 0}
    @media(min-width:640px){.carousel-window>.pf{flex-basis:calc(40% - 12px);margin-right:24px}}
    @media(min-width:1024px){.carousel-window>.pf{flex-basis:calc(25% - 18px);margin-right:24px}}
    @media(min-width:1400px){.carousel-window>.pf{flex-basis:calc(20% - 19.2px);margin-right:24px}}
    .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);z-index:10;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.9);border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.1);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text);transition:all .2s}
    .carousel-btn:hover{background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.12);transform:translateY(-50%) scale(1.05)}
    .carousel-btn:disabled{opacity:.3;cursor:not-allowed;transform:translateY(-50%)}
    .carousel-btn.prev{left:-22px}.carousel-btn.next{right:-22px}
    @media(max-width:767px){.carousel-btn.prev{left:-10px}.carousel-btn.next{right:-10px}}

    #featured h3{font-weight:800;font-size:22px;margin-bottom:12px;font-family:'Playfair Display',serif}
    .featured-wrap{position:relative}
    .featured-grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:640px){.featured-grid{grid-template-columns:repeat(3,1fr)}}
    .fc{display:flex;flex-direction:column;gap:12px;padding:14px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:var(--elev-1);cursor:pointer}
    .fc:hover{box-shadow:var(--elev-3);transform:translateY(-2px);transition:all .2s}
    .fc-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .fc-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:800;color:#222}
    .fc-sub{color:var(--muted);font-size:13px}
    .fc-body{display:grid;grid-template-columns:72px 1fr;gap:12px;align-items:center}
    .fc-img{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#e2e8f0}

    .brand-link, .perfumer-link, .note-link, .accord-link {font-weight: 600;color: var(--brand-secondary);transition: color .2s;cursor: pointer;}
    .brand-link:hover, .perfumer-link:hover, .note-link:hover, .accord-link:hover {color: var(--brand-primary);text-decoration: underline;}
    .pf-brand.brand-link:hover { color: var(--brand-secondary); }
    .chip.note-link:hover, .chip.accord-link:hover {background-color: #e2e8f0;border-color: #d1d5db;color: var(--text);}
    .chip.accord-link { cursor: pointer; transition: all .2s; }

    /* Similars update visual */
    #simOut{transition:opacity .25s}
    #simOut.updating{opacity:.35;filter:saturate(.95)}

    .toast{position:fixed;bottom:24px;left:50%;transform:translate(-50%,16px);background:var(--text);color:#fff;padding:12px 18px;border-radius:12px;box-shadow:var(--elev-2);opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:9999;font-weight:700;font-size:15px;letter-spacing:.2px}
    .toast.show{opacity:1;transform:translate(-50%,0)}
    .toast.err{background:linear-gradient(135deg,#ef4444,#b91c1c)}
    .toast.info{background:linear-gradient(135deg,#64748b,#334155)}
    .fab{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border:none;border-radius:999px;display:grid;place-items:center;color:#fff;background:var(--text);box-shadow:var(--elev-3);cursor:pointer;opacity:0;transform:translateY(12px) scale(.96);pointer-events:none;transition:opacity .25s,transform .25s;z-index:9998}
    .fab.show{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}

    [data-debug-outline] *{outline:1px dashed rgba(100,116,139,.35)}
  </style>
</head>
<body>
<main class="landing" id="appRoot">
  <div class="card"><div class="card-inner">
    <div class="top">
      <div class="brand">
        <img class="logo" src="/assets/logo.svg" alt="simscent" width="32" height="32">simscent
      </div>
      <button class="cta" id="signupBtn">Kayıt Ol</button>
    </div>

    <section id="hero" class="hero">
      <div class="shot-wrap">
        <div class="blob"></div>
        <img id="heroShot" class="shot" src="https://images.unsplash.com/photo-1617839400561-d55457a29da2?q=80&w=930&auto=format&fit=crop" alt="parfüm"/>
        <div class="blob2"></div>
      </div>
      <div>
        <h1 class="title">İmza Kokunu<br/>Keşfet</h1>
        <p class="desc">Benzersiz tercihlerinle eşleşen parfümleri keşfet. Hazır koleksiyonumuzu incele ve sana en uygun eşleşmeyi bul.</p>

        <div class="search-wrap">
          <div class="searchbar">
            <input id="searchInput" type="text" placeholder="Bir parfüm ara, örn: 'Aventus'" autocomplete="off" aria-label="Parfüm ara"/>
            <button id="searchBtn" class="icon-btn" title="Ara" aria-label="Ara">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <div id="suggestions" class="suggest" role="listbox" aria-label="Öneriler"></div>
        </div>

        <div class="actions">
          <a class="btn primary" href="#results">Koleksiyonu Keşfet</a>
          <button class="btn ghost" id="surpriseBtn" type="button">Beni Şaşırt!</button>
        </div>
      </div>
    </section>

    <section class="section" id="featured" style="display:none">
      <h3>Öne Çıkan Koleksiyonlar</h3>
      <div class="featured-wrap">
        <div id="featuredGrid" class="featured-grid"></div>
        <button id="featPrev" class="carousel-btn prev" aria-label="Önceki">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button id="featNext" class="carousel-btn next" aria-label="Sonraki">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>
    </section>

    <!-- 1) SONUÇLAR -->
    <section class="section" id="results">
      <h3 style="font-weight:800;font-size:22px;margin-bottom:12px;font-family:'Playfair Display',serif">Sonuçlar</h3>
      <div id="out"><div style="text-align:center;padding:40px 20px;background:var(--shell);border-radius:16px"><h4 style="font-weight:700;font-size:18px;color:var(--text);font-family:'Playfair Display',serif">Keşfetmeye Başla</h4><p style="color:var(--muted);margin-top:4px">Başlamak için yukarıdan bir parfüm arayın veya “Beni Şaşırt!” butonunu kullanın.</p></div></div>
    </section>

    <!-- 2) EŞLEŞME ÖNCELİKLERİ -->
    <section class="section" id="upload-section" style="display:none">
      <div class="prefs-head">
        <div class="prefs-head-top">
          <h3 style="font-weight:800;font-size:22px;font-family:'Playfair Display',serif;margin:0">Eşleşme Öncelikleri</h3>
          <div class="prefs-actions">
            <span class="chip small" id="prefsActiveChip">4 aktif</span>
            <button class="link-reset" id="prefReset" type="button">Sıfırla</button>
            <button class="collapse-btn" id="prefCollapseBtn" type="button" aria-expanded="true" aria-label="Öncelikleri daralt/aç">
              <span class="material-symbols-outlined">expand_less</span>
            </button>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:8px;color:var(--muted);font-size:13px">
          <span class="chip small">Benzeri Parfümler için geçerli</span>
          <span>Bu ayarları değiştir, benzerler anında güncellensin.</span>
        </div>
      </div>

      <div class="card" style="box-shadow:none;border:1px solid var(--border);padding:16px" id="prefs">
        <div class="pref-grid">
          <div class="row" title="Gündelik/Gece gibi kullanım senaryolarını daha çok öne çıkar.">
            <span class="lbl">Kullanım Amacı</span>
            <div class="toggle active" data-pref="usage" aria-label="Kullanım Amacına önem ver"><div class="dot"></div></div>
          </div>
          <div class="row" title="Mevsim uyumunu daha çok öne çıkar.">
            <span class="lbl">Mevsim</span>
            <div class="toggle active" data-pref="season" aria-label="Mevsime önem ver"><div class="dot"></div></div>
          </div>
          <div class="row" title="Klasik/Modern gibi stil uyumunu daha çok öne çıkar.">
            <span class="lbl">Stil</span>
            <div class="toggle active" data-pref="style" aria-label="Stile önem ver"><div class="dot"></div></div>
          </div>
          <div class="row" title="Odunsu, Çiçeksi vb. koku ailelerini daha çok öne çıkar.">
            <span class="lbl">Koku Ailesi</span>
            <div class="toggle active" data-pref="family" aria-label="Koku Ailesine önem ver"><div class="dot"></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) BENZERİ PARFÜMLER -->
    <section class="section" id="similars" style="display:none">
      <h3 id="similarsTitle" style="font-weight:800;font-size:22px;margin-bottom:12px;font-family:'Playfair Display',serif">Benzeri Parfümler</h3>
      <div id="simOut"></div>
    </section>

  </div></div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<button id="fabTop" class="fab" aria-label="Yukarı kaydır" title="Yukarı">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5l0 14M5.5 11.5L12 5l6.5 6.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

<script>
'use strict';
(function(){
  const DEBUG = /[?#&]debug\b|__DEBUG__=1/.test(location.href);
  const log = Object.assign(function(...a){ if(DEBUG) console.log('%c[simscent]', 'color:#6366f1;font-weight:700', ...a); },{
    warn:(...a)=>DEBUG&&console.warn('[simscent]',...a), error:(...a)=>DEBUG&&console.error('[simscent]',...a), group:(l)=>DEBUG&&console.group(l), end:()=>DEBUG&&console.groupEnd()
  });

  const q=(s,r=document)=>{const el=r.querySelector(s); if(!el) throw new Error('Selector not found: '+s); return el;};
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const on=(el,ev,fn,opt)=>el.addEventListener(ev,fn,opt);

  const state = {
    data: [], fuse: null, currentRef: null,
    featured: { pairs: [], topMap: new Map(), topList: [], picks: [], page: 0 }
  };

  const KEYS = {
    usage:['Daily','Business','Evening','Night Out','Leisure','Sport'],
    season:['Spring','Summer','Fall','Winter'],
    style:['Classic','Masculine','Feminine','Modern'],
    family:['Animal','Aquatic','Chypre','Citrus','Creamy','Earthy','Floral','Fougère','Fresh','Fruity','Gourmand','Green','Leathery','Oriental','Powdery','Resinous','Smoky','Spicy','Sweet','Synthetic','Woody']
  };

  const LABELS = {Daily:'Günlük',Business:'İş',Evening:'Akşam','Night Out':'Gece',Leisure:'Rahat',Sport:'Spor',Spring:'İlkbahar',Summer:'Yaz',Fall:'Sonbahar',Winter:'Kış',Classic:'Klasik',Masculine:'Maskülen',Feminine:'Feminen',Modern:'Modern'};
  const ICONS  = {Daily:'sunny',Business:'work',Evening:'nights_stay','Night Out':'nightlife',Leisure:'weekend',Sport:'directions_run',Spring:'local_florist',Summer:'sunny',Fall:'eco',Winter:'ac_unit',Classic:'account_balance',Masculine:'man',Feminine:'woman',Modern:'auto_awesome', style:'style'};
  const FAMILY_TR = {Animal:'Hayvansı',Aquatic:'Akvatik',Chypre:'Şipre',Citrus:'Narenciye',Creamy:'Kremamsı',Earthy:'Topraksı',Floral:'Çiçeksi','Fougère':'Fujer',Fresh:'Ferahlık',Fruity:'Meyvemsi',Gourmand:'Gurme',Green:'Yeşil',Leathery:'Deri',Oriental:'Oryantal',Powdery:'Pudramsı',Resinous:'Reçineli',Smoky:'Dumanlı',Spicy:'Baharatlı',Sweet:'Tatlı',Synthetic:'Sentetik',Woody:'Odunsu'};
  const ACCORD_TR = {'woody':'Odunsu','aromatic':'Aromatik','fresh spicy':'Taze Baharatlı','citrus':'Narenciye','amber':'Amber','warm spicy':'Sıcak Baharatlı','green':'Yeşil','sweet':'Tatlı','musky':'Misk','fruity':'Meyvemsi','powdery':'Pudramsı','vanilla':'Vanilya','floral':'Çiçeksi','white floral':'Beyaz Çiçeksi','rose':'Gül','oud':'Öd','smoky':'Dumanlı','leather':'Deri','earthy':'Topraksı','animalic':'Hayvansı','aquatic':'Akvatik','patchouli':'Paçuli','iris':'İris','balsamic':'Balsamik','tobacco':'Tütün','cinnamon':'Tarçın','spicy':'Baharatlı','resinous':'Reçineli','chypre':'Şipre','fougère':'Fujer','gourmand':'Gurme','creamy':'Kremamsı','synthetic':'Sentetik','fresh':'Ferah'};

  const toPct=(v)=>{const n=Number(v);return !isFinite(n)?0:(n<11?Math.round(n*10):Math.round(n))};
  function showToast(msg,type='ok'){ const t=q('#toast'); if(!t){ if(DEBUG) console.log('[toast]', msg); return; } t.textContent=msg; t.className=`toast ${type||'ok'} show`; clearTimeout(window.__toastTimer); window.__toastTimer=setTimeout(()=>t.classList.remove('show'),2000); }
  function setMeta(name, content){
    let m = document.querySelector(`meta[name="${name}"]`);
    if (!m) { m = document.createElement('meta'); m.name = name; document.head.appendChild(m); }
    m.setAttribute('content', content);
  }

  function addFullName(arr){
    for(const p of arr){
      const name=p['Fragrance Name']||p.name||'';
      const conc=p.Concentration||p.concentration||'';
      p.fullName=(conc?`${name} ${conc}`:name).trim();
      const yr=p['Release Year']!=null?String(p['Release Year']):'';
      p._search=[p.Brand,name,conc,yr].filter(Boolean).join(' ').toLowerCase();
    }
    return arr;
  }

  function parseFlexibleJSON(text){
    try{
      const parsed=JSON.parse(text);
      if(Array.isArray(parsed)) return parsed;
      if(parsed&&typeof parsed==='object'){
        if(Array.isArray(parsed.data)) return parsed.data;
        if(Array.isArray(parsed.items)) return parsed.items;
      }
    }catch(_){}
    const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean), arr=[];
    for(const ln of lines){ try{const o=JSON.parse(ln); if(o&&typeof o==='object') arr.push(o);}catch(_){} }
    if(arr.length) return arr;
    throw new Error('Geçersiz JSON');
  }

  function buildFuse(){ if(!state.data.length){ state.fuse=null; return; }
    state.fuse=new Fuse(state.data,{includeScore:true,threshold:0.38,ignoreLocation:true,keys:[
      {name:'fullName',weight:0.6},{name:'Brand',weight:0.35},{name:'Concentration',weight:0.5},{name:'Release Year',weight:0.25},{name:'Fragrance Name',weight:0.6},{name:'_search',weight:1.0}
    ]});
  }

  function vecSim(a,b,keys){ let dot=0,n1=0,n2=0; for(const k of keys){ const x=Number(a[k]||0)||0, y=Number(b[k]||0)||0; dot+=x*y; n1+=x*x; n2+=y*y; } return (!n1||!n2)?0:dot/(Math.sqrt(n1)*Math.sqrt(n2)); }
  function topKey(p,keys){ let best=null,max=-1; for(const k of keys){ const v=Number(p[k]||0); if(v>max){max=v; best=k;} } return max>0.01?best:null; }

  function usedFamilyKeys(data){ return KEYS.family.filter(k => data.some(p => Number(p[k]||0) > 0)); }
  function cosine(v1,v2){
    let dot=0,n1=0,n2=0; const L=Math.min(v1.length,v2.length);
    for(let i=0;i<L;i++){ const a=+v1[i]||0, b=+v2[i]||0; dot+=a*b; n1+=a*a; n2+=b*b; }
    if(!n1||!n2) return 0;
    return dot/(Math.sqrt(n1)*Math.sqrt(n2));
  }
  function buildFeaturedIndex(){
    const cats = usedFamilyKeys(state.data);
    const N = state.data.length;
    if(!N || cats.length<2){
      state.featured = { pairs:[], topMap:new Map(), topList:[], picks:[], page: 0 };
      return;
    }
    const vectors = new Map();
    for(const c of cats){
      const arr = new Array(N);
      for(let i=0;i<N;i++) arr[i] = Number(state.data[i][c]||0) || 0;
      vectors.set(c, arr);
    }
    const allPairs=[];
    for(let i=0;i<cats.length;i++){
      for(let j=i+1;j<cats.length;j++){
        const a=cats[i], b=cats[j];
        const sim = cosine(vectors.get(a), vectors.get(b));
        allPairs.push({a,b,sim});
      }
    }
    allPairs.sort((x,y)=>y.sim-x.sim);
    let topPairs = allPairs.filter(p=>isFinite(p.sim) && p.sim>=0.35).slice(0,10);
    if(topPairs.length<3) topPairs = allPairs.filter(p=>p.sim>=0.20).slice(0,10);
    if(topPairs.length<3) topPairs = allPairs.slice(0,10);

    const topMap=new Map(), topList=[];
    for(const {a,b} of topPairs){
      let scored = state.data.map((p,idx)=>{
        const score=(+p[a]||0)+(+p[b]||0);
        return {idx, perfume:p, score};
      }).filter(x=>x.score>0).sort((u,v)=>v.score-u.score).slice(0,20);

      if(scored.length===0){
        scored = state.data.map((p,idx)=>{
          const ma=(p['Main Accords']||'').toLowerCase();
          const hit=(ma.includes(a.toLowerCase())?1:0)+(ma.includes(b.toLowerCase())?1:0);
          return {idx, perfume:p, score:hit};
        }).filter(x=>x.score>0).sort((u,v)=>v.score-u.score).slice(0,20);
      }

      const key=`${a}|${b}`;
      topMap.set(key, scored);
      topList.push({ key, a, b, items: scored });
    }
    state.featured = { pairs: topPairs, topMap, topList, picks: [], page: 0 };
  }
  function pickFeatured(count = 3){
    const { pairs, topMap, page } = state.featured;
    if(!pairs.length){ state.featured.picks = []; return; }
    const pool = pairs.slice(0, 10);
    const start = (page * count) % pool.length;
    const chosenPairs = [];
    for(let i=0;i<count;i++) chosenPairs.push(pool[(start + i) % pool.length]);

    const picks = [];
    for(let i=0;i<chosenPairs.length;i++){
      const p = chosenPairs[i];
      const key = `${p.a}|${p.b}`;
      const items = topMap.get(key) || [];
      const len = Math.min(items.length, 20);
      if(len===0){ picks.push({key, a:p.a, b:p.b, choice:null, list:[], rank:null}); continue; }

      let idx = Math.floor(Math.random()*len);
      for(let tries=0; tries<4 && picks.some(px => px.choice?.idx === items[idx]?.idx); tries++){
        idx = Math.floor(Math.random()*len);
      }
      const choice = items[idx];
      picks.push({ key, a: p.a, b: p.b, choice, list: items, rank: idx + 1 });
    }
    state.featured.picks = picks;
  }

  function score(value,label){
    const v=Math.max(0,Math.min(100, (Number(value)<11?Math.round(value*10):Math.round(value))));
    const R=24,C=2*Math.PI*R,off=C-(v/100)*C;
    return `<div class='s-item'><div class='ring'><svg class='svg' viewBox='0 0 54 54'><circle class='bg' cx='27' cy='27' r='${R}'></circle><circle class='fg' cx='27' cy='27' r='${R}' stroke-dasharray='${C}' stroke-dashoffset='${off}'></circle></svg><div class='val'><span class='vtext'>${isNaN(v)?'?':v}</span></div></div><div class='lbl2'>${label}</div></div>`;
  }
  function renderCard(perf, type){
    const isRef=type==='ref'; const p=isRef?perf:perf.perfume;
    const simTxt=isRef?'Referans Parfümünüz': (typeof perf.similarity==='number' ? `${Math.round(perf.similarity*100)}% Benzer` : 'Öneri');
    const img=p['Image URL']||`https://placehold.co/240x240/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
    const el=document.createElement('div'); el.className=`pf ${isRef?'ref':''}`;
    el.innerHTML=`
      <img class='pf-img' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://placehold.co/240x240/e2e8f0/64748b?text=Hata'"/>
      <div>
        <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:8px'>
          <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||''}</div>
          <div class='badge'>${simTxt}</div>
        </div>
        <div class='pf-name' style="margin-top:4px">${p.fullName||''}</div>
      </div>`;
    if(!isRef){
      el.style.cursor='pointer';
      on(el,'click',() => setReferenceAndFindSimilar(p, true));
    }
    return el;
  }
  function renderRefDetail(p){
    const img=p['Image URL']||`https://placehold.co/480x480/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
    const lon=toPct(p.Longevity), scent=toPct(p.Scent), sil=toPct(p.Sillage), val=toPct(p['Value for Money']);
    const sourceLink=p.URL?`<a href='${p.URL}' target='_blank' rel='noopener noreferrer' class='btn ghost' style='display:flex;align-items:center;gap:8px;justify-content:center;width:100%;margin-top:16px;'>Parfumo'da Görüntüle</a>`:'';

    const releaseYear = p['Release Year'] && p['Release Year'] !== 'N/A' && p['Release Year'] !== 'Unknown' ? String(p['Release Year']) : null;
    const perfumers = (p.Perfumer || '').split(',').map(name => name.trim()).filter(name => name && name !== 'N/A' && name !== 'Unknown');
    let subDetailsHTML = '';
    const perfumerLinks = perfumers.map(name => `<span class='perfumer-link' data-perfumer='${encodeURIComponent(name)}'>${name}</span>`).join(', ');

    if (releaseYear && perfumers.length > 0) {
      subDetailsHTML = `<p class='ref-card-sub'>${releaseYear} • ${perfumerLinks}</p>`;
    } else if (releaseYear) {
      subDetailsHTML = `<p class='ref-card-sub'>${releaseYear}</p>`;
    } else if (perfumers.length > 0) {
      subDetailsHTML = `<p class='ref-card-sub'>${perfumerLinks}</p>`;
    }

    const topUsage=topKey(p,KEYS.usage), topSeason=topKey(p,KEYS.season), topStyle=topKey(p,KEYS.style);
    const tags=[topUsage,topSeason,topStyle].filter(Boolean);
    const tagsHTML = tags.length?`
      <div class="detail-section"><h4 class='detail-section-title'>Öne Çıkan Özellikler</h4>
        <div class='chips'>
          ${tags.map(k=>`<span class='chip'><span class="material-symbols-outlined">${ICONS[k]||ICONS.style||'label'}</span>${LABELS[k]||k}</span>`).join('')}
        </div>
      </div>`:'';

    const notes = p['Fragrance Notes'] || '';
    const notesHTML = notes ? `
    <div class="detail-section">
      <h4 class='detail-section-title'>Notalar</h4>
      <div class='chips'>
        ${notes.split(',').map(s => s.trim()).filter(Boolean).map(note =>
          `<span class='chip note-link' data-note='${encodeURIComponent(note)}'>${note}</span>`
        ).join('')}
      </div>
    </div>` : '';

    const el=document.createElement('div'); el.className='card'; el.style.boxShadow='var(--elev-1)';
    el.innerHTML=`
      <div class="card-inner">
        <div class="ref-card-grid">
          <div>
            <img class='ref-card-image' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://google.com/images/cleardot.gif'"/>
            ${sourceLink}
            ${notesHTML}
          </div>
          <div>
            <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||'—'}</div>
            <h2 class='ref-card-title'>${p.fullName||''}</h2>
            ${subDetailsHTML}
            <div class="detail-section">
              <h4 class='detail-section-title'>Ana Akordlar</h4>
              <div class='chips'>${(p['Main Accords']||'').split(',').map(s=>s.trim()).filter(Boolean).map(a=>`<span class='chip accord-link' data-accord='${encodeURIComponent(a)}'>${ACCORD_TR[a.toLowerCase()] || a}</span>`).join('') || '<span class="chip" style="opacity:.7">Belirtilmedi</span>'}</div>
            </div>
            ${tagsHTML}
            <div class="detail-section">
              <h4 class='detail-section-title'>Puanlar</h4>
              <div class='scores'>${score(lon,'Kalıcılık')}${score(scent,'Koku')}${score(sil,'Yayılım')}${score(val,'Değer')}</div>
            </div>
          </div>
        </div>
      </div>`;
    return el;
  }

  function setupCarousel(container){
    const windowEl=container.querySelector('.carousel-window');
    const prevBtn=container.querySelector('.carousel-btn.prev');
    const nextBtn=container.querySelector('.carousel-btn.next');
    const cards=Array.from(windowEl.children);
    if(!cards.length) return;
    const check=()=>{ const can=windowEl.scrollWidth>windowEl.clientWidth; prevBtn.style.display=nextBtn.style.display=can?'flex':'none'; };
    const update=()=>{ const atStart=windowEl.scrollLeft<10; const atEnd=Math.abs(windowEl.scrollWidth-windowEl.clientWidth-windowEl.scrollLeft)<10; prevBtn.disabled=atStart; nextBtn.disabled=atEnd; };
    prevBtn.addEventListener('click',()=>{ const w=cards[0].offsetWidth; windowEl.scrollBy({left:-(w+24),behavior:'smooth'})});
    nextBtn.addEventListener('click',()=>{ const w=cards[0].offsetWidth; windowEl.scrollBy({left:(w+24),behavior:'smooth'})});
    windowEl.addEventListener('scroll',update,{passive:true});
    new ResizeObserver(()=>{check();update();}).observe(windowEl);
    check(); update();
  }

  function similarities(target,prefs){
    return state.data.map(p=>{
      if(p.fullName===target.fullName) return {perfume:p, similarity:-1};
      let s=0,w=0; for(const k in prefs){ if(prefs[k]){ s+=vecSim(target,p,KEYS[k]); w++; } }
      const avg=w? s/w : 0; return {perfume:p, similarity: Math.pow(avg,3)};
    }).filter(x=>x.similarity!==-1).sort((a,b)=>b.similarity-a.similarity);
  }

  /* ------- UI helpers for prefs ------- */
  function activePrefCount(){ return qa('#prefs .toggle.active').length; }
  function updatePrefUI(){
    const n = activePrefCount();
    const chip = document.getElementById('prefsActiveChip');
    if(chip) chip.textContent = `${n} aktif`;
    const btn = document.getElementById('prefCollapseBtn');
    if(btn) btn.setAttribute('aria-expanded', String(!document.getElementById('upload-section').classList.contains('collapsed')));
  }
  function beginSimUpdate(){
    const el = document.getElementById('simOut');
    if(el){ el.classList.add('updating'); }
  }

  // UPDATED: render reference in #results, similars in #similars
  function render(ref,sims){
    state.currentRef=ref;

    // 1) Referans detayları (Sonuçlar)
    const out=q('#out'); out.innerHTML='';
    out.appendChild(renderRefDetail(ref));

    // 2) Benzeri Parfümler (Tercihler'den sonra)
    const simSec = q('#similars');
    const simTitle = q('#similarsTitle');
    const simOut = q('#simOut');
    simOut.innerHTML = '';
    simOut.style.opacity = .35; // subtle fade-in

    if(sims.length){
      simTitle.textContent = `${ref.fullName || 'Seçtiğiniz Parfüm'} Benzeri Parfümler`;

      const carouselContainer=document.createElement('div'); carouselContainer.className='carousel-container';
      carouselContainer.innerHTML=`
        <div class="carousel-window"></div>
        <button class="carousel-btn prev" aria-label="Önceki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
        <button class="carousel-btn next" aria-label="Sonraki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>`;
      const windowEl=carouselContainer.querySelector('.carousel-window');
      sims.forEach(s=>windowEl.appendChild(renderCard(s,'sim')));
      simOut.appendChild(carouselContainer);
      simSec.style.display = 'block';
      setupCarousel(carouselContainer);
    } else {
      simSec.style.display = 'none';
    }

    // end of update animation
    requestAnimationFrame(()=>{ simOut.classList.remove('updating'); simOut.style.opacity = 1; });
  }

  // When navigating to collections, hide similars (since no single ref)
  function hideSimilars(){ const sec = document.getElementById('similars'); if(sec) sec.style.display='none'; const out = document.getElementById('simOut'); if(out) out.innerHTML=''; }

  function showPerfumerResults(name) {
    hideSimilars();
    const out = q('#out'); out.innerHTML = '';
    const results = state.data.filter(p => p.Perfumer && p.Perfumer.toLowerCase().includes(name.toLowerCase()));
    const header = document.createElement('div'); header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;';
    const title = document.createElement('h3'); title.style.cssText = "font-weight:800;font-size:22px;font-family:'Playfair Display',serif;"; title.textContent = `${name} Koleksiyonu (${results.length})`;
    const backBtn = document.createElement('button'); backBtn.className = 'btn ghost'; backBtn.textContent = 'Geri Dön'; on(backBtn,'click',()=>findSimilar(false));
    header.appendChild(title); header.appendChild(backBtn); out.appendChild(header);
    if (!results.length){ out.innerHTML += '<p>Bu parfümör için sonuç bulunamadı.</p>'; return; }
    const grid = document.createElement('div'); grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;';
    results.forEach(p => {
      const year = p['Release Year'] || '';
      const img = p['Image URL'] || `https://placehold.co/240x240/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
      const el = document.createElement('div'); el.className='pf'; el.style.cursor='pointer';
      el.innerHTML = `
        <img class='pf-img' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://placehold.co/240x240/e2e8f0/64748b?text=Hata'"/>
        <div>
          <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:8px'>
            <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||''}</div>
            ${year ? `<div class='badge' style="background:var(--shell); color: var(--text); border:1px solid var(--border);">${year}</div>` : ''}
          </div>
          <div class='pf-name' style="margin-top:4px">${p.fullName||''}</div>
        </div>`;
      on(el,'click',()=>setReferenceAndFindSimilar(p,true));
      grid.appendChild(el);
    });
    out.appendChild(grid); out.scrollIntoView({ behavior: 'smooth' });
  }

  function showBrandResults(brandName) {
    hideSimilars();
    const out = q('#out'); out.innerHTML = '';
    const results = state.data.filter(p => p.Brand && p.Brand.toLowerCase() === brandName.toLowerCase());
    const header = document.createElement('div'); header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;';
    const title = document.createElement('h3'); title.style.cssText = "font-weight:800;font-size:22px;font-family:'Playfair Display',serif;"; title.textContent = `${brandName} Koleksiyonu (${results.length})`;
    const backBtn = document.createElement('button'); backBtn.className = 'btn ghost'; backBtn.textContent = 'Geri Dön'; on(backBtn,'click',()=>findSimilar(false));
    header.appendChild(title); header.appendChild(backBtn); out.appendChild(header);
    if (!results.length){ out.innerHTML += '<p>Bu marka için sonuç bulunamadı.</p>'; return; }
    const grid = document.createElement('div'); grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;';
    results.forEach(p => {
      const year = p['Release Year'] || '';
      const img = p['Image URL'] || `https://placehold.co/240x240/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
      const el = document.createElement('div'); el.className='pf'; el.style.cursor='pointer';
      el.innerHTML = `
        <img class='pf-img' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://placehold.co/240x240/e2e8f0/64748b?text=Hata'"/>
        <div>
          <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:8px'>
            <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||''}</div>
            ${year ? `<div class='badge' style="background:var(--shell); color: var(--text); border:1px solid var(--border);">${year}</div>` : ''}
          </div>
          <div class='pf-name' style="margin-top:4px">${p.fullName||''}</div>
        </div>`;
      on(el,'click',()=>setReferenceAndFindSimilar(p,true));
      grid.appendChild(el);
    });
    out.appendChild(grid); out.scrollIntoView({ behavior: 'smooth' });
  }

  function showAccordResults(accordName) {
    hideSimilars();
    const out = q('#out'); out.innerHTML = '';
    const results = state.data
      .filter(p => p['Main Accords'] && p['Main Accords'].toLowerCase().includes(accordName.toLowerCase()))
      .sort((a,b) => (b[accordName] || 0) - (a[accordName] || 0) )
      .slice(0,20);
    const header = document.createElement('div'); header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;';
    const title = document.createElement('h3'); title.style.cssText = "font-weight:800;font-size:22px;font-family:'Playfair Display',serif;"; title.textContent = `'${accordName}' Akorduna Sahip Parfümler (${results.length})`;
    const backBtn = document.createElement('button'); backBtn.className = 'btn ghost'; backBtn.textContent = 'Geri Dön'; on(backBtn,'click',()=>findSimilar(false));
    header.appendChild(title); header.appendChild(backBtn); out.appendChild(header);
    if (!results.length){ out.innerHTML += `<p>Bu akorda sahip sonuç bulunamadı.</p>`; return; }
    const grid = document.createElement('div'); grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;';
    results.forEach(p => {
      const year = p['Release Year'] || '';
      const img = p['Image URL'] || `https://placehold.co/240x240/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
      const el = document.createElement('div'); el.className='pf'; el.style.cursor='pointer';
      el.innerHTML = `
        <img class='pf-img' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://placehold.co/240x240/e2e8f0/64748b?text=Hata'"/>
        <div>
          <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:8px'>
            <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||''}</div>
            ${year ? `<div class='badge' style="background:var(--shell); color: var(--text); border:1px solid var(--border);">${year}</div>` : ''}
          </div>
          <div class='pf-name' style="margin-top:4px">${p.fullName||''}</div>
        </div>`;
      on(el,'click',()=>setReferenceAndFindSimilar(p,true));
      grid.appendChild(el);
    });
    out.appendChild(grid); out.scrollIntoView({ behavior: 'smooth' });
  }

  function showNoteResults(noteName) {
    hideSimilars();
    const out = q('#out'); out.innerHTML = '';
    const results = state.data.filter(p => p['Fragrance Notes'] && p['Fragrance Notes'].toLowerCase().includes(noteName.toLowerCase()));
    const header = document.createElement('div'); header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;';
    const title = document.createElement('h3'); title.style.cssText = "font-weight:800;font-size:22px;font-family:'Playfair Display',serif;"; title.textContent = `'${noteName}' Notalı Parfümler (${results.length})`;
    const backBtn = document.createElement('button'); backBtn.className = 'btn ghost'; backBtn.textContent = 'Geri Dön'; on(backBtn,'click',()=>findSimilar(false));
    header.appendChild(title); header.appendChild(backBtn); out.appendChild(header);
    if (!results.length){ out.innerHTML += `<p>Bu notayı içeren sonuç bulunamadı.</p>`; return; }
    const grid = document.createElement('div'); grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;';
    results.forEach(p => {
      const year = p['Release Year'] || '';
      const img = p['Image URL'] || `https://placehold.co/240x240/e2e8f0/64748b?text=${encodeURIComponent((p.Brand||'?').slice(0,1))}`;
      const el = document.createElement('div'); el.className='pf'; el.style.cursor='pointer';
      el.innerHTML = `
        <img class='pf-img' src='${img}' alt='${p.fullName}' onerror="this.onerror=null;this.src='https://placehold.co/240x240/e2e8f0/64748b?text=Hata'"/>
        <div>
          <div style='display:flex;justify-content:space-between;align-items:flex-start;gap:8px'>
            <div class='pf-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand||''}</div>
            ${year ? `<div class='badge' style="background:var(--shell); color: var(--text); border:1px solid var(--border);">${year}</div>` : ''}
          </div>
          <div class='pf-name' style="margin-top:4px">${p.fullName||''}</div>
        </div>`;
      on(el,'click',()=>setReferenceAndFindSimilar(p,true));
      grid.appendChild(el);
    });
    out.appendChild(grid); out.scrollIntoView({ behavior: 'smooth' });
  }

  function renderFeatured(){
    const sec = q('#featured'); const grid = q('#featuredGrid');
    grid.innerHTML = ''; const picks = state.featured.picks || []; sec.style.display = 'block';
    if(!picks.length){
      grid.innerHTML = `<div class="fc" style="grid-column: 1/-1;">
        <div class="fc-head"><div>
          <div class="fc-title">Öne Çıkan Koleksiyonlar</div>
          <div class="fc-sub">Uygun kategori çifti bulunamadı. Lütfen başka bir JSON deneyin.</div>
        </div></div></div>`;
      return;
    }
    for(const p of picks){
      const perf = p.choice?.perfume;
      const img = perf?.['Image URL'] || `https://placehold.co/144x144/e2e8f0/64748b?text=${encodeURIComponent((perf?.Brand||'?').slice(0,1))}`;
      const title = `${(FAMILY_TR?.[p.a]||p.a)} & ${(FAMILY_TR?.[p.b]||p.b)}`;
      const brandName = perf ? (perf.Brand||'') : '—';
      const fragName = perf ? (perf.fullName||'Seçim bulunamadı') : 'Seçim bulunamadı';
      const el = document.createElement('div'); el.className='fc';
      el.innerHTML = `
        <div class="fc-head">
          <div>
            <div class="fc-title">${title}</div>
            <div class="fc-sub">Bu ikilinin seçkisinden</div>
          </div>
        </div>
        <div class="fc-body">
          <img class="fc-img" src="${img}" alt="${fragName}" onerror="this.onerror=null;this.src='https://placehold.co/144x144/e2e8f0/64748b?text=?'"/>
          <div>
            <div class="pf-brand brand-link" style="margin-bottom:4px" data-brand="${encodeURIComponent(brandName)}">${brandName}</div>
            <div class="pf-name">${fragName}</div>
            <div class="fc-sub" style="margin-top:4px"><small>Top 20 içinde <b>${p.rank}.</b> sıradaki öneri</small></div>
          </div>
        </div>`;
      el.addEventListener('click', ()=>{ if(!perf) return; setReferenceAndFindSimilar(perf, true); });
      grid.appendChild(el);
    }
  }

  function wireEvents(){
    on(q('.brand'), 'click', resetToHome);

    // Toggle click: update, animate, toast
    qa('#prefs .row').forEach(row=>{
      on(row,'click',(e)=>{
        const toggle = e.target.closest('.toggle') || row.querySelector('.toggle');
        if(toggle) {
          toggle.classList.toggle('active');
          updatePrefUI();
          beginSimUpdate();
          showToast('Öneriler güncellendi','info');
          findSimilar(false);
        }
      });
    });

    const collapseBtn = document.getElementById('prefCollapseBtn');
    on(collapseBtn,'click',()=>{
      const sec = document.getElementById('upload-section');
      sec.classList.toggle('collapsed');
      updatePrefUI();
      // ikon değiştir
      const icon = collapseBtn.querySelector('.material-symbols-outlined');
      icon.textContent = sec.classList.contains('collapsed') ? 'expand_more' : 'expand_less';
    });

    const resetBtn = document.getElementById('prefReset');
    on(resetBtn,'click',()=>{
      qa('#prefs .toggle').forEach(t=>t.classList.add('active'));
      updatePrefUI();
      beginSimUpdate();
      showToast('Ayarlar sıfırlandı','info');
      findSimilar(false);
    });

    const input=q('#searchInput'); const btn=q('#searchBtn'); const suggest=q('#suggestions'); let deb=null;
    on(input,'input',()=>{
      clearTimeout(deb);
      deb=setTimeout(()=>{
        const qv=input.value.trim();
        if(!qv||!state.fuse){ suggest.style.display='none'; return;}
        const res=state.fuse.search(qv).slice(0,8);
        if(!res.length){suggest.style.display='none';return;}
        suggest.innerHTML=res.map(r=>{
          const it=r.item; const t=thumbURL(it);
          const yr= it['Release Year']!=null && it['Release Year']!=='' ? String(it['Release Year']) : '';
          const right=(it.Brand||yr)? `(${[it.Brand, yr].filter(Boolean).join(', ')})` : '';
          return `<div class='s-item' data-index='${r.refIndex}' aria-label='${it.fullName} ${right}'>
            <img class='s-thumb' src='${t}' alt='' loading='lazy' onerror="this.onerror=null;this.src='https://placehold.co/40x40/e2e8f0/64748b?text=?'"/>
            <div class='s-name'>${it.fullName}</div>
            <div class='s-brand'>${right}</div>
          </div>`;
        }).join('');
        suggest.style.display='block';
      },140);
    });
    on(suggest,'click',e=>{ const el=e.target.closest('.s-item'); if(!el) return; const idx = parseInt(el.dataset.index, 10); if(!isNaN(idx) && state.data[idx]) { setReferenceAndFindSimilar(state.data[idx], true); } suggest.style.display='none'; });
    on(document,'click',e=>{ if(!suggest.contains(e.target) && e.target!==input) suggest.style.display='none'; });
    on(input,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); suggest.style.display='none'; findSimilar(); }});
    on(btn,'click',()=>{ suggest.style.display='none'; findSimilar(); });

    on(q('#appRoot'), 'click', e => {
      const perfumerLink = e.target.closest('.perfumer-link'); if (perfumerLink) { e.stopPropagation(); const name = decodeURIComponent(perfumerLink.dataset.perfumer); if (name) showPerfumerResults(name); return; }
      const brandLink = e.target.closest('.brand-link'); if (brandLink) { e.stopPropagation(); const name = decodeURIComponent(brandLink.dataset.brand); if (name) showBrandResults(name); return; }
      const accordLink = e.target.closest('.accord-link'); if (accordLink) { e.stopPropagation(); const name = decodeURIComponent(accordLink.dataset.accord); if (name) showAccordResults(name); return; }
      const noteLink = e.target.closest('.note-link'); if (noteLink) { e.stopPropagation(); const name = decodeURIComponent(noteLink.dataset.note); if (name) showNoteResults(name); return; }
    });

    on(q('#surpriseBtn'),'click', handleSurprise);
    on(q('#signupBtn'),'click',()=>showToast('Yakında!','info'));

    const prev=q('#featPrev'), next=q('#featNext');
    on(prev,'click',()=>{ const {pairs}=state.featured; const count=3; const pages=Math.max(1, Math.ceil(Math.min(pairs.length,10)/count)); state.featured.page = (state.featured.page - 1 + pages) % pages; pickFeatured(count); renderFeatured(); });
    on(next,'click',()=>{ const {pairs}=state.featured; const count=3; const pages=Math.max(1, Math.ceil(Math.min(pairs.length,10)/count)); state.featured.page = (state.featured.page + 1) % pages; pickFeatured(count); renderFeatured(); });

    const fab=q('#fabTop');
    const toggleFab=()=>{ if(window.scrollY>280){ fab.classList.add('show'); } else { fab.classList.remove('show'); } };
    on(window,'scroll',toggleFab,{passive:true}); toggleFab();
    on(fab,'click',()=>window.scrollTo({top:0,behavior:'smooth'}));
  }

  function handleRealRouting(){
    const path = location.pathname;
    const regex = /^\/p\/([^/]+)\/([^/]+)/;
    const match = path.match(regex);
    if (!match) { if (state.currentRef) { resetToHome(false); } return; }
    const [, brandSlug, fragSlug] = match;
    const perfumeName = decodeURIComponent(fragSlug).replace(/-/g, ' ');
    if (state.currentRef && perfumeName === state.currentRef.fullName) return;
    if (state.fuse) {
      const result = state.fuse.search(perfumeName);
      if (result.length > 0 && result[0].item) { log(`Path'ten bulundu: ${perfumeName}`); setReferenceAndFindSimilar(result[0].item, true); }
      else { log.warn(`Path'ten parfüm bulunamadı: ${perfumeName}`); resetToHome(); }
    } else { setTimeout(handleRealRouting, 200); }
  }

  function setReferenceAndFindSimilar(ref, scroll = true) {
    if (!ref) { showToast('Geçerli bir parfüm seçilemedi.', 'err'); return; }
    state.currentRef = ref; q('#searchInput').value = ref.fullName;
    document.title = `${ref.fullName} — simscent`;
    setMeta('description', `${ref.Brand} ${ref.fullName} notalar, akordlar ve benzer parfümler.`);

    const slugify = (text) => text.toString().toLowerCase()
      .replace(/&/g, 'and').replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-');

    const brandSlug = slugify(ref.Brand || 'unknown');
    const fragSlug  = slugify(ref.fullName);
    const newPath   = `/p/${brandSlug}/${fragSlug}`;

    if (location.pathname !== newPath) history.pushState({ perfume: ref.fullName }, '', newPath);

    showPrefs();

    const prefs = {
      usage: q('.toggle[data-pref="usage"]').classList.contains('active'),
      season: q('.toggle[data-pref="season"]').classList.contains('active'),
      style: q('.toggle[data-pref="style"]').classList.contains('active'),
      family: q('.toggle[data-pref="family"]').classList.contains('active')
    };
    beginSimUpdate();
    const sims = similarities(ref, prefs).slice(0, 10);
    render(ref, sims);
    if (scroll) q('#results').scrollIntoView({ behavior: 'smooth' });

    pickFeatured(3);
    renderFeatured();
  }

  function findSimilar(scroll=true){
    if(!state.data.length){ return; }
    const qv=q('#searchInput').value.trim();
    if (!qv && state.currentRef) { setReferenceAndFindSimilar(state.currentRef, scroll); return; }
    if (qv) {
      const searchResult = state.fuse?.search(qv);
      const ref = searchResult?.[0]?.item;
      if(!ref){ showToast('Parfüm bulunamadı. Farklı bir arama deneyin.','err'); return; }
      setReferenceAndFindSimilar(ref, scroll);
      return;
    }
    if (!state.currentRef) showToast('Lütfen bir parfüm arayın veya "Beni Şaşırt!" butonunu kullanın.', 'info');
  }

  function handleSurprise(){
    if(!state.data.length){ return; }
    const idx=Math.floor(Math.random()*state.data.length); const p=state.data[idx];
    setHeroFromPerfume(p);
    setReferenceAndFindSimilar(p, true);
  }

  function resetToHome(pushState = true) {
    state.currentRef = null; q('#searchInput').value = '';
    q('#upload-section').style.display = 'none';
    q('#similars').style.display = 'none';
    const simOutEl = document.getElementById('simOut'); if (simOutEl) simOutEl.innerHTML='';
    document.title = 'simscent — Ana Sayfa';
    setMeta('description', 'Benzersiz tercihlerinle eşleşen parfümleri keşfet. Hazır koleksiyonumuzu incele ve sana en uygun eşleşmeyi bul.');
    const homePath = '/';
    if (pushState && location.pathname !== homePath) history.pushState({}, '', homePath);

    if (state.data.length > 0) {
      const idx = Math.floor(Math.random() * state.data.length);
      const rnd = state.data[idx];
      setHeroFromPerfume(rnd);
    }
    q('#out').innerHTML = `<div style="text-align:center;padding:40px 20px;background:var(--shell);border-radius:16px"><h4 style="font-weight:700;font-size:18px;color:var(--text);font-family:'Playfair Display',serif">Koleksiyon Yüklendi</h4><p style="color:var(--muted);margin-top:4px">Bir parfüm arayabilir veya "Beni Şaşırt!" butonunu kullanabilirsiniz.</p></div>`;
    if (pushState) window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showPrefs(){
    const sec = q('#upload-section');
    sec.style.display = 'block';
    updatePrefUI();
  }
  function thumbURL(item){ const brand=(item.Brand||'?')+''; const letter=encodeURIComponent(brand.slice(0,1)); return item['Image URL']||`https://placehold.co/40x40/e2e8f0/64748b?text=${letter}`; }
  function setHeroFromPerfume(p){
    const shot = q('#heroShot'); const img = p['Image URL'] || '';
    if(img){ shot.src = img; shot.alt = p.fullName || 'parfüm'; shot.onerror = function(){ this.onerror=null; this.src='https://images.unsplash.com/photo-1523292562811-8fa7962a78c8?q=80&w=1200&auto=format&fit=crop'; }; }
    q('#searchInput').placeholder = `Bir parfüm ara, örn: '${p.fullName || 'Aventus'}'`;
  }

  function loadInitialUI(){
    q('#out').innerHTML = `<div style="text-align:center;padding:40px 20px;background:#f8fafc;border-radius:16px;"><h4 style="font-weight:700;font-size:18px;color:#0f172a;font-family:'Playfair Display',serif;">Veri Yükleniyor...</h4><p style="color:#475569;margin-top:4px">Lütfen bekleyin, parfüm koleksiyonu hazırlanıyor.</p></div>`;
  }

  async function loadInitialData() {
    try {
      const response = await fetch('/perfumes_data.json');
      if (!response.ok) throw new Error(`HTTP hatası! Durum: ${response.status}`);
      const text = await response.text();
      const txt = text.replace(/:\s*NaN/gi,': null');
      let data = parseFlexibleJSON(txt);
      if(!Array.isArray(data) || !data.length) throw new Error('JSON dosyası boş veya geçersiz.');

      data=addFullName(data); state.data=data; buildFuse(); buildFeaturedIndex(); pickFeatured(3); renderFeatured();

      const idx = Math.floor(Math.random()*data.length);
      const rnd = data[idx];
      setHeroFromPerfume(rnd);

      q('#upload-section').style.display = 'none';
      q('#similars').style.display = 'none';
      q('#out').innerHTML = `<div style="text-align:center;padding:40px 20px;background:var(--shell);border-radius:16px"><h4 style="font-weight:700;font-size:18px;color:var(--text);font-family:'Playfair Display',serif">Koleksiyon Yüklendi</h4><p style="color:var(--muted);margin-top:4px">Bir parfüm arayabilir veya "Beni Şaşırt!" butonunu kullanabilirsiniz.</p></div>`;
      showToast(`✅ ${data.length} parfüm başarıyla yüklendi.`,'ok');

      window.addEventListener('popstate', handleRealRouting);
      handleRealRouting();
    } catch (err) {
      log.error(err);
      showToast(`❌ Veri yüklenemedi: ${err.message}`,'err');
      q('#out').innerHTML = `<div style="text-align:center;padding:40px 20px;background:var(--shell);border-radius:16px"><h4 style="font-weight:700;font-size:18px;color:var(--text);font-family:'Playfair Display',serif">Yükleme Başarısız</h4><p style="color:var(--muted);margin-top:4px">'perfumes_data.json' dosyası bulunamadı veya hatalı. Lütfen konsolu kontrol edin.</p></div>`;
    }
  }

  window.simscent = {
    getState:()=>({ count:state.data.length, hasFuse:!!state.fuse, currentRef: state.currentRef, featured: state.featured }),
    loadJSON:(txt)=>{ const data=addFullName(parseFlexibleJSON(txt)); state.data=data; buildFuse(); buildFeaturedIndex(); pickFeatured(3); renderFeatured(); log('Manual load', data.length); showPrefs(); },
    nextFeatured:()=>{ const {pairs}=state.featured; const count=3; const pages=Math.max(1, Math.ceil(Math.min(pairs.length,10)/count)); state.featured.page=(state.featured.page+1)%pages; pickFeatured(count); renderFeatured(); }
  };

  function init(){ wireEvents(); loadInitialUI(); loadInitialData(); }
  init();
})();
</script>
</body>
</html>
