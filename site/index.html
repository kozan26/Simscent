<!DOCTYPE html>
<html lang="tr">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7LCE4Z60ZB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7LCE4Z60ZB');
  </script>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simscent — Koku Rehberin</title>
  <meta name="description" content="Zevkine en uygun parfümleri bul, koleksiyonları incele ve kendi imza kokunu anında keşfet."/>
  <meta name="google-adsense-account" content="ca-pub-9033780165680589">
  <link rel="canonical" href="https://www.simscent.com/"/>

  <link rel="icon" href="/assets/logo.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/assets/favicon-32.png" sizes="32x32" type="image/png">

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,500..700,0..1,-50..200"/>
  
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <style>
    /* --- VARIABLES & BASE STYLES --- */
    :root {
      --brand-primary: #C1A77E;
      --brand-secondary: #A08C62;
      --text-primary: #2d333a;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
      --shell-bg: #f9f9f8;
      --shell-bg-alt: #f3f4f6;
      --shadow-sm: 0 4px 15px rgba(0,0,0,.04);
      --shadow-md: 0 8px 30px rgba(0,0,0,.06);
      --shadow-lg: 0 12px 40px rgba(0,0,0,.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
      background-color: var(--shell-bg);
      -webkit-font-smoothing: antialiased;
    }
    h1, h2, h3, h4, .font-serif {
      font-family: 'Playfair Display', serif;
      letter-spacing: -0.02em;
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0,'wght' 500,'GRAD' 0,'opsz' 24;
      display: inline-flex;
      align-items: center;
      vertical-align: -5px;
      font-size: 20px;
      line-height: 1;
    }

    /* --- LAYOUT & CARD --- */
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    @media (min-width: 768px) { .container { margin: 2.5rem auto; padding: 0 2rem; } }
    .main-card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 28px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      position: relative;
    }
    .main-card-inner { padding: clamp(1.5rem, 4vw, 2.5rem); }
    .section {
      padding: 2.5rem 0;
      border-top: 1px dashed var(--border-color);
    }
    .section-header { margin-bottom: 1.5rem; }
    .section-title {
      font-size: clamp(1.5rem, 5vw, 1.75rem);
      font-weight: 800;
    }
    .section-subtitle {
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    .placeholder {
      text-align: center;
      padding: 3rem 1.5rem;
      background-color: var(--shell-bg);
      border-radius: 16px;
    }
    .placeholder-title { font-size: 1.25rem; color: var(--text-primary); }
    .placeholder-text { color: var(--text-secondary); margin-top: 0.5rem; }

    /* --- COMPONENTS --- */
    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 1rem; }
    .brand { display: flex; align-items: center; gap: 0.75rem; font-weight: 800; font-size: 1.5rem; font-family: 'Playfair Display', serif; cursor: pointer; }
    .brand img { width: 36px; height: 36px; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }
    .btn-primary { background-color: var(--text-primary); color: #fff; }
    .btn-primary:hover { background-color: #000; box-shadow: var(--shadow-sm); transform: translateY(-2px); }
    .btn-secondary { background-color: transparent; color: var(--text-primary); border-color: var(--border-color); }
    .btn-secondary:hover { border-color: #ccc; background-color: var(--shell-bg); }
    .icon-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      display: grid;
      place-items: center;
      background-color: var(--text-primary);
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .icon-btn:hover { background-color: #000; }

    /* Hero */
    .hero {
      display: grid;
      grid-template-columns: 1fr;
      gap: 3rem;
      align-items: center;
      margin-top: 2rem;
    }
    @media (min-width: 980px) { .hero { grid-template-columns: 400px 1fr; gap: 4rem; } }
    .hero-image-wrapper { position: relative; }
    .hero-image {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
    }
    .hero-title {
      font-size: clamp(2.75rem, 6vw, 4rem);
      font-weight: 800;
      line-height: 1.05;
      color: #111;
      margin-bottom: 1rem;
    }
    .hero-desc { color: var(--text-secondary); max-width: 500px; font-size: 1.125rem; }
    .hero-actions { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; }

    /* Search & Suggestions */
    .search-wrapper { margin: 2rem 0 1rem; max-width: 500px; position: relative; z-index: 60; }
    .search-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 0.5rem 0.5rem 0.5rem 1.25rem;
      box-shadow: var(--shadow-sm);
    }
    .search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      color: var(--text-primary);
    }
    .search-bar input::placeholder { color: #9ca3af; }
    .suggestions {
      display: none;
      position: absolute;
      left: 0; right: 0; top: 100%;
      margin-top: 0.75rem;
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      max-height: 320px;
      overflow: auto;
      text-align: left;
      z-index: 70;
    }
    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .suggestion-item:hover { background-color: var(--shell-bg); }
    .suggestion-item img { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; background-color: var(--shell-bg-alt); flex-shrink: 0; }
    .suggestion-item .name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .suggestion-item .brand { color: var(--text-secondary); font-size: 0.875rem; margin-left: auto; white-space: nowrap; }

    /* Preference Toggles */
    .pref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem; }
    .pref-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background-color: #fff;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .pref-row.active { border-color: var(--brand-secondary); background-color: #fdfaf4; }
    .pref-label-wrap { display: flex; align-items: center; gap: 0.5rem; }
    .pref-label { font-size: 1rem; font-weight: 600; }

    /* Perfume Cards (Shared styles) */
    .perfume-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      border-radius: 18px;
      padding: 0.75rem;
      border: 1px solid transparent;
      box-shadow: var(--shadow-sm);
      background-color: #fff;
      transition: box-shadow .2s, transform .2s, border-color .2s;
      overflow: hidden;
    }
    .perfume-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); border-color: rgba(193, 167, 126, 0.4); }
    .perfume-card-img { width: 100%; aspect-ratio: 1/1; border-radius: 12px; object-fit: cover; background-color: var(--shell-bg-alt); }
    .perfume-card-brand { font-size: 0.8rem; letter-spacing: .4px; text-transform: uppercase; color: var(--brand-primary); font-weight: 700; }
    .perfume-card-name { font-family: 'Playfair Display', serif; font-size: 1.2rem; line-height: 1.25; font-weight: 700; }
    .perfume-card-badge { background-color: var(--brand-primary); color: #fff; padding: 0.3rem 0.8rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
    .perfume-card-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid var(--border-color);
      background-color: var(--shell-bg);
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-size: 0.825rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .perfume-card-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    
    /* Reference Perfume Detail */
    .ref-card-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; align-items: start; }
    @media (min-width: 920px) { .ref-card-grid { grid-template-columns: 320px 1fr; gap: 3rem; } }
    .ref-card-image { width: 100%; max-width: 320px; margin: 0 auto; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; box-shadow: var(--shadow-md); }
    .ref-card-title { font-size: clamp(1.75rem, 4vw, 2.25rem); font-weight: 700; line-height: 1.2; color: #111; margin: 0.25rem 0 0; }
    .ref-card-sub { color: var(--text-secondary); font-size: 1rem; margin-top: 0.5rem; margin-bottom: 1.75rem; }
    .detail-section { padding-top: 1.5rem; margin-top: 1.5rem; border-top: 1px solid var(--shell-bg); }
    .detail-section:first-of-type { margin-top: 0; padding-top: 0; border-top: 0; }
    .detail-section-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .8px; }

    /* Score Rings */
    .scores-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center; }
    .score-item .label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }

    /* Interactive Links */
    .brand-link, .perfumer-link, .note-link, .accord-link {
      font-weight: 600;
      color: var(--brand-secondary);
      transition: color .2s;
      cursor: pointer;
    }
    .brand-link:hover, .perfumer-link:hover, .note-link:hover, .accord-link:hover {
      color: var(--brand-primary);
      text-decoration: underline;
    }
    .perfume-card-chip.note-link:hover, .perfume-card-chip.accord-link:hover {
      background-color: var(--shell-bg-alt);
      border-color: #d1d5db;
    }

    /* Carousel */
    .carousel-container { position: relative; }
    .carousel-window {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 1rem;
    }
    .carousel-window::-webkit-scrollbar { display: none; }
    .carousel-window > .perfume-card {
      flex: 0 0 75%;
      scroll-snap-align: start;
      margin: 0.75rem 1rem 0.75rem 0;
    }
    @media (min-width: 640px) { .carousel-window > .perfume-card { flex-basis: 45%; margin-right: 1.5rem; } }
    @media (min-width: 1024px) { .carousel-window > .perfume-card { flex-basis: calc(25% - 1.25rem); } }
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      width: 44px; height: 44px;
      border-radius: 50%;
      background: rgba(255,255,255,.95);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      transition: all .2s;
    }
    .carousel-btn:hover { background: #fff; box-shadow: var(--shadow-md); transform: translateY(-50%) scale(1.05); }
    .carousel-btn:disabled { opacity: .4; cursor: not-allowed; transform: translateY(-50%); }
    .carousel-btn.prev { left: -22px; }
    .carousel-btn.next { right: -22px; }
    @media (max-width: 767px) {
      .carousel-btn.prev { left: -10px; }
      .carousel-btn.next { right: -10px; }
    }
    
    /* Featured Collections */
    .featured-grid { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
    @media (min-width: 768px) { .featured-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1024px) { .featured-grid { grid-template-columns: repeat(3, 1fr); } }
    .featured-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: all .2s;
    }
    .featured-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-4px); }
    .featured-card-title { font-size: 1.25rem; font-weight: 800; color: #222; }
    .featured-card-body { display: grid; grid-template-columns: 72px 1fr; gap: 1rem; align-items: center; }
    .featured-card-img { width: 72px; height: 72px; border-radius: 12px; object-fit: cover; background-color: var(--shell-bg-alt); }
    .featured-card .perfume-card-brand { margin-bottom: 0.25rem; display: block; }
    .featured-card .perfume-card-name { font-size: 1.1rem; }

    /* Toast & FAB */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translate(-50%, 1rem);
      background-color: var(--text-primary);
      color: #fff;
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s, transform .25s;
      z-index: 9999;
      font-weight: 600;
      font-size: 1rem;
    }
    .toast.show { opacity: 1; transform: translate(-50%, 0); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #b91c1c); }
    .toast.info { background: linear-gradient(135deg, #64748b, #334155); }
    .fab {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      width: 56px; height: 56px;
      border: none;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: #fff;
      background-color: var(--text-primary);
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      opacity: 0;
      transform: translateY(12px) scale(.96);
      pointer-events: none;
      transition: opacity .25s, transform .25s;
      z-index: 9998;
    }
    .fab.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
  </style>
</head>
<body>

<main class="container">
  <div class="main-card">
    <div class="main-card-inner">
      <header class="header">
        <div class="brand">
          <img src="/assets/logo.svg" alt="Simscent Logosu" width="36" height="36">
          <span>Simscent</span>
        </div>
        <button class="btn btn-primary" id="signupBtn">Hesap Oluştur</button>
      </header>

      <section id="hero" class="hero">
        <div class="hero-image-wrapper">
          <img id="heroImage" class="hero-image" src="https://images.unsplash.com/photo-1617839400561-d55457a29da2?q=80&w=930&auto=format&fit=crop" alt="Şık bir parfüm şişesi"/>
        </div>
        <div>
          <h1 class="hero-title">Kokunun Büyüsünü Keşfet</h1>
          <p class="hero-desc">Zevkine en uygun parfümleri bul, koleksiyonları incele ve kendi imza kokunu yarat.</p>

          <div class="search-wrapper">
            <div class="search-bar">
              <input id="searchInput" type="text" placeholder="Bir parfüm ara, örn: 'Aventus'" autocomplete="off" aria-label="Parfüm ara"/>
              <button id="searchBtn" class="icon-btn" title="Ara" aria-label="Ara">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
            <div id="suggestions" class="suggestions" role="listbox"></div>
          </div>

          <div class="hero-actions">
            <a class="btn btn-primary" href="#results">Koleksiyonu Keşfet</a>
            <button class="btn btn-secondary" id="surpriseBtn" type="button">
              <span class="material-symbols-outlined">auto_awesome</span> Beni Şaşırt!
            </button>
          </div>
        </div>
      </section>

      <section class="section" id="featured" style="display:none;">
        <div class="section-header">
          <h3 class="section-title font-serif">Öne Çıkan Koleksiyonlar</h3>
          <p class="section-subtitle">Birbiriyle uyumlu koku ailelerinden seçkiler.</p>
        </div>
        <div id="featuredGrid" class="featured-grid"></div>
      </section>

      <section class="section" id="results">
        <div id="refDetailOut">
          <div class="placeholder">
            <h4 class="placeholder-title font-serif">Keşfetmeye Başla</h4>
            <p class="placeholder-text">Başlamak için bir parfüm arayın veya “Beni Şaşırt!” butonunu kullanın.</p>
          </div>
        </div>
      </section>

      <section class="section" id="similarity-prefs" style="display:none;">
        <div class="section-header">
            <h3 class="section-title font-serif">Arama Filtreleri</h3>
            <p class="section-subtitle">Benzerlikleri bu kriterlere göre hesapla.</p>
        </div>
        <div id="prefsGrid" class="pref-grid">
          </div>
      </section>

      <section class="section" id="similar" style="display:none;">
        <div class="section-header">
          <h3 class="section-title font-serif">Benzer Kokular</h3>
          <p class="section-subtitle">Seçtiğin parfüme en çok benzeyen öneriler.</p>
        </div>
        <div id="similarOut"></div>
      </section>

    </div>
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<button id="fabTop" class="fab" aria-label="Yukarı kaydır" title="Yukarı">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5l0 14M5.5 11.5L12 5l6.5 6.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

<script>
'use strict';
(function() {
  // --- CONFIG & CONSTANTS ---
  const DEBUG = window.location.search.includes('debug');
  const log = {
    info: (...args) => DEBUG && console.log('%c[simscent]', 'color:#6366f1;font-weight:700', ...args),
    warn: (...args) => DEBUG && console.warn('[simscent]', ...args),
    error: (...args) => DEBUG && console.error('[simscent]', ...args),
  };

  // DOM element selectors
  const SELECTORS = {
    appRoot: '#appRoot',
    heroImage: '#heroImage',
    searchInput: '#searchInput',
    searchBtn: '#searchBtn',
    suggestions: '#suggestions',
    surpriseBtn: '#surpriseBtn',
    signupBtn: '#signupBtn',
    featuredGrid: '#featuredGrid',
    results: '#results',
    refDetailOut: '#refDetailOut',
    prefsSection: '#similarity-prefs',
    prefsGrid: '#prefsGrid',
    similarSection: '#similar',
    similarOut: '#similarOut',
    toast: '#toast',
    fabTop: '#fabTop',
  };

  // Data keys for similarity calculations
  const SIMILARITY_KEYS = {
    usage: ['Daily', 'Business', 'Evening', 'Night Out', 'Leisure', 'Sport'],
    season: ['Spring', 'Summer', 'Fall', 'Winter'],
    style: ['Classic', 'Masculine', 'Feminine', 'Modern'],
    family: ['Animal', 'Aquatic', 'Chypre', 'Citrus', 'Creamy', 'Earthy', 'Floral', 'Fougère', 'Fresh', 'Fruity', 'Gourmand', 'Green', 'Leathery', 'Oriental', 'Powdery', 'Resinous', 'Smoky', 'Spicy', 'Sweet', 'Synthetic', 'Woody']
  };

  // Turkish labels for keys
  const LABELS_TR = {
    usage: 'Kullanım Amacı', season: 'Mevsim', style: 'Stil', family: 'Koku Ailesi',
    Daily: 'Günlük', Business: 'İş', Evening: 'Akşam', 'Night Out': 'Gece', Leisure: 'Rahat', Sport: 'Spor',
    Spring: 'İlkbahar', Summer: 'Yaz', Fall: 'Sonbahar', Winter: 'Kış',
    Classic: 'Klasik', Masculine: 'Maskülen', Feminine: 'Feminen', Modern: 'Modern',
    Animal:'Hayvansı', Aquatic:'Akvatik', Chypre:'Şipre', Citrus:'Narenciye', Creamy:'Kremamsı', Earthy:'Topraksı', Floral:'Çiçeksi', Fougère:'Fujer', Fresh:'Ferahlık', Fruity:'Meyvemsi', Gourmand:'Gurme', Green:'Yeşil', Leathery:'Deri', Oriental:'Oryantal', Powdery:'Pudramsı', Resinous:'Reçineli', Smoky:'Dumanlı', Spicy:'Baharatlı', Sweet:'Tatlı', Synthetic:'Sentetik', Woody:'Odunsu',
    'woody':'Odunsu', 'aromatic':'Aromatik', 'fresh spicy':'Taze Baharatlı', 'citrus':'Narenciye', 'amber':'Amber', 'warm spicy':'Sıcak Baharatlı', 'green':'Yeşil', 'sweet':'Tatlı', 'musky':'Misk', 'fruity':'Meyvemsi', 'powdery':'Pudramsı', 'vanilla':'Vanilya', 'floral':'Çiçeksi', 'white floral':'Beyaz Çiçeksi', 'rose':'Gül', 'oud':'Öd', 'smoky':'Dumanlı', 'leather':'Deri', 'earthy':'Topraksı', 'animalic':'Hayvansı', 'aquatic':'Akvatik', 'patchouli':'Paçuli', 'iris':'İris', 'balsamic':'Balsamik', 'tobacco':'Tütün', 'cinnamon':'Tarçın'
  };

  // --- STATE MANAGEMENT ---
  const state = {
    data: [],
    fuse: null,
    currentRef: null,
    featured: { picks: [] },
  };
  
  // --- UTILITY FUNCTIONS ---
  const q = (selector, parent = document) => parent.querySelector(selector);
  const qa = (selector, parent = document) => Array.from(parent.querySelectorAll(selector));
  const on = (element, event, handler, options) => element.addEventListener(event, handler, options);
  const toPercent = (value) => Math.round(Math.max(0, Math.min(100, (Number(value) < 11 ? Number(value) * 10 : Number(value)))));
  const slugify = (text) => text.toString().toLowerCase()
      .replace(/&/g, 'and').replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-');

  /**
   * Shows a toast message.
   * @param {string} message - The message to display.
   * @param {'ok'|'info'|'error'} type - The type of toast.
   */
  function showToast(message, type = 'ok') {
    const toastEl = q(SELECTORS.toast);
    if (!toastEl) { log.warn('[toast]', message); return; }
    toastEl.textContent = message;
    toastEl.className = `toast ${type} show`;
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => toastEl.classList.remove('show'), 3000);
  }

  // --- DATA PROCESSING ---
  /**
   * Adds a 'fullName' property to each perfume object.
   * @param {Array<Object>} perfumeArray - The array of perfume data.
   * @returns {Array<Object>} The augmented array.
   */
  function addFullName(perfumeArray) {
    return perfumeArray.map(p => {
      const name = p['Fragrance Name'] || p.name || '';
      const conc = p.Concentration || p.concentration || '';
      p.fullName = (conc ? `${name} ${conc}` : name).trim();
      return p;
    });
  }
  
  /**
   * Calculates cosine similarity between two perfumes based on selected keys.
   * @param {Object} p1 - First perfume object.
   * @param {Object} p2 - Second perfume object.
   * @param {Array<string>} keys - The keys to use for calculation.
   * @returns {number} The similarity score (0 to 1).
   */
  function vectorSimilarity(p1, p2, keys) {
    let dotProduct = 0, norm1 = 0, norm2 = 0;
    for (const key of keys) {
      const val1 = Number(p1[key] || 0);
      const val2 = Number(p2[key] || 0);
      dotProduct += val1 * val2;
      norm1 += val1 * val1;
      norm2 += val2 * val2;
    }
    return (norm1 === 0 || norm2 === 0) ? 0 : dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
  }

  // --- RENDERING FUNCTIONS ---
  
  /**
   * Creates a DOM element with specified options.
   * @param {string} tag - The HTML tag name.
   * @param {Object} [options] - Options for the element (className, text, children, etc.).
   * @returns {HTMLElement} The created element.
   */
  function createEl(tag, options = {}) {
    const el = document.createElement(tag);
    if (options.className) el.className = options.className;
    if (options.text) el.textContent = options.text;
    if (options.html) el.innerHTML = options.html;
    if (options.children) options.children.forEach(child => child && el.appendChild(child));
    for (const attr in options.attrs) el.setAttribute(attr, options.attrs[attr]);
    for (const data in options.data) el.dataset[data] = options.data[data];
    return el;
  }

  /**
   * Renders the similarity preference toggles.
   */
  function renderPrefToggles() {
    const grid = q(SELECTORS.prefsGrid);
    grid.innerHTML = '';
    Object.keys(SIMILARITY_KEYS).forEach(key => {
        const row = createEl('div', {
            className: 'pref-row active',
            data: { pref: key },
            children: [
                createEl('div', {
                    className: 'pref-label-wrap',
                    children: [createEl('span', { className: 'pref-label', text: LABELS_TR[key] || key })]
                }),
                createEl('div', { className: 'perfume-card-badge', text: 'Aktif' })
            ]
        });
        on(row, 'click', () => {
            row.classList.toggle('active');
            row.querySelector('.perfume-card-badge').textContent = row.classList.contains('active') ? 'Aktif' : 'Pasif';
            findSimilar(false);
        });
        grid.appendChild(row);
    });
  }

  /**
   * Renders a perfume card.
   * @param {Object} perfumeData - The perfume object.
   * @param {'ref' | 'sim'} type - The type of card.
   * @param {number} [similarityScore] - The similarity score if type is 'sim'.
   * @returns {HTMLElement} The card element.
   */
  function renderPerfumeCard(perfumeData, type, similarityScore) {
    const isRef = type === 'ref';
    const badgeText = isRef ? 'Referans' : `${toPercent(similarityScore)}% Benzer`;
    const imageUrl = perfumeData['Image URL'] || `https://placehold.co/240x240/f3f4f6/6b7280?text=${encodeURIComponent((perfumeData.Brand || '?').slice(0, 1))}`;

    const card = createEl('div', {
        className: `perfume-card ${isRef ? 'ref' : ''}`,
        children: [
            createEl('img', { className: 'perfume-card-img', attrs: { src: imageUrl, alt: perfumeData.fullName, loading: 'lazy' }}),
            createEl('div', {
                children: [
                    createEl('div', {
                        className: 'flex-between',
                        html: `<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                 <div class="perfume-card-brand brand-link" data-brand="${encodeURIComponent(perfumeData.Brand || '')}">${perfumeData.Brand || ''}</div>
                                 <div class="perfume-card-badge">${badgeText}</div>
                               </div>
                               <div class="perfume-card-name" style="margin-top:4px">${perfumeData.fullName || ''}</div>`
                    })
                ]
            })
        ]
    });
    if (!isRef) {
        card.style.cursor = 'pointer';
        on(card, 'click', () => setReferenceAndFindSimilar(perfumeData, true));
    }
    return card;
  }
  
  /**
   * Renders the detailed view for the reference perfume.
   * @param {Object} p - The perfume object.
   */
  function renderRefDetail(p) {
    const container = q(SELECTORS.refDetailOut);
    container.innerHTML = '';
    
    const imageUrl = p['Image URL'] || `https://placehold.co/480x480/f3f4f6/6b7280?text=${encodeURIComponent((p.Brand || '?').slice(0, 1))}`;
    
    const perfumers = (p.Perfumer || '').split(',').map(name => name.trim()).filter(Boolean);
    const subDetails = [p['Release Year'], perfumers.map(name => `<span class='perfumer-link' data-perfumer='${encodeURIComponent(name)}'>${name}</span>`).join(', ')].filter(Boolean).join(' • ');

    const mainAccords = (p['Main Accords'] || '').split(',').map(s => s.trim()).filter(Boolean);
    const notes = (p['Fragrance Notes'] || '').split(',').map(s => s.trim()).filter(Boolean);

    const refCard = createEl('div', { className: 'ref-card-grid', html: `
      <div>
        <img class='ref-card-image' src='${imageUrl}' alt='${p.fullName}'/>
        ${p.URL ? `<a href='${p.URL}' target='_blank' rel='noopener noreferrer' class='btn btn-secondary' style='width:100%; margin-top:1.5rem;'>Parfumo'da Görüntüle</a>` : ''}
      </div>
      <div>
        <div class='perfume-card-brand brand-link' data-brand="${encodeURIComponent(p.Brand || '')}">${p.Brand || '—'}</div>
        <h2 class='ref-card-title'>${p.fullName || ''}</h2>
        ${subDetails ? `<p class='ref-card-sub'>${subDetails}</p>` : ''}
        
        <div class="detail-section">
          <h4 class='detail-section-title'>Ana Akordlar</h4>
          <div class='perfume-card-chips'>${mainAccords.length ? mainAccords.map(a => `<span class='perfume-card-chip accord-link' data-accord='${encodeURIComponent(a)}'>${LABELS_TR[a.toLowerCase()] || a}</span>`).join('') : '<span class="perfume-card-chip" style="opacity:.7">Belirtilmedi</span>'}</div>
        </div>
        
        <div class="detail-section">
          <h4 class='detail-section-title'>Puanlar</h4>
          <div class='scores-grid'>
            <div class="score-item"><div class="perfume-card-badge">${toPercent(p.Longevity)}</div><div class="label">Kalıcılık</div></div>
            <div class="score-item"><div class="perfume-card-badge">${toPercent(p.Scent)}</div><div class="label">Koku</div></div>
            <div class="score-item"><div class="perfume-card-badge">${toPercent(p.Sillage)}</div><div class="label">Yayılım</div></div>
            <div class="score-item"><div class="perfume-card-badge">${toPercent(p['Value for Money'])}</div><div class="label">Değer</div></div>
          </div>
        </div>

        ${notes.length ? `
        <div class="detail-section">
          <h4 class='detail-section-title'>Notalar</h4>
          <div class='perfume-card-chips'>${notes.map(note => `<span class='perfume-card-chip note-link' data-note='${encodeURIComponent(note)}'>${note}</span>`).join('')}</div>
        </div>` : ''}
      </div>
    `});

    container.appendChild(refCard);
  }

  /**
   * Renders the similar perfumes carousel.
   * @param {Array<Object>} similarPerfumes - Array of similar perfume objects.
   */
  function renderSimilar(similarPerfumes) {
    const section = q(SELECTORS.similarSection);
    const container = q(SELECTORS.similarOut);
    container.innerHTML = '';
    
    if (!similarPerfumes.length) {
      section.style.display = 'none';
      return;
    }
    
    const carouselHTML = `
      <div class="carousel-container">
        <div class="carousel-window"></div>
        <button class="carousel-btn prev" aria-label="Önceki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
        <button class="carousel-btn next" aria-label="Sonraki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
      </div>`;
    container.innerHTML = carouselHTML;
    
    const windowEl = container.querySelector('.carousel-window');
    similarPerfumes.forEach(s => windowEl.appendChild(renderPerfumeCard(s.perfume, 'sim', s.similarity)));
    
    section.style.display = 'block';
    setupCarousel(container.querySelector('.carousel-container'));
  }

  // --- CORE LOGIC ---

  /**
   * Sets the reference perfume and finds similar ones.
   * @param {Object} refPerfume - The selected reference perfume.
   * @param {boolean} [scroll=true] - Whether to scroll to the results.
   */
  function setReferenceAndFindSimilar(refPerfume, scroll = true) {
    if (!refPerfume) {
      showToast('Geçerli bir parfüm seçilemedi.', 'error');
      return;
    }
    state.currentRef = refPerfume;
    q(SELECTORS.searchInput).value = refPerfume.fullName;
    
    // Update page meta
    document.title = `${refPerfume.fullName} — Simscent`;
    const newPath = `/p/${slugify(refPerfume.Brand || 'na')}/${slugify(refPerfume.fullName)}`;
    if (window.location.pathname !== newPath) {
      history.pushState({ perfume: refPerfume.fullName }, '', newPath);
    }
    
    q(SELECTORS.prefsSection).style.display = 'block';

    const activePrefs = {};
    qa(`${SELECTORS.prefsGrid} .pref-row.active`).forEach(row => {
        activePrefs[row.dataset.pref] = true;
    });

    const similar = state.data
      .map(p => {
        if (p.fullName === refPerfume.fullName) return { perfume: p, similarity: -1 };
        let totalSim = 0, weightCount = 0;
        for (const key in activePrefs) {
          if (activePrefs[key]) {
            totalSim += vectorSimilarity(refPerfume, p, SIMILARITY_KEYS[key]);
            weightCount++;
          }
        }
        const avgSim = weightCount > 0 ? totalSim / weightCount : 0;
        return { perfume: p, similarity: Math.pow(avgSim, 3) }; // Pow to emphasize higher scores
      })
      .filter(item => item.similarity !== -1)
      .sort((a, b) => b.similarity - a.similarity)
      .slice(0, 12);

    renderRefDetail(refPerfume);
    renderSimilar(similar);
    
    if (scroll) q(SELECTORS.results).scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  /**
   * Initiates a search based on the input field or current reference.
   * @param {boolean} [scroll=true] - Whether to scroll to the results.
   */
  function findSimilar(scroll = true) {
    if (!state.data.length) return;
    const query = q(SELECTORS.searchInput).value.trim();
    
    if (query) {
      const searchResult = state.fuse?.search(query);
      const ref = searchResult?.[0]?.item;
      if (ref) {
        setReferenceAndFindSimilar(ref, scroll);
      } else {
        showToast('Parfüm bulunamadı. Farklı bir arama deneyin.', 'error');
      }
    } else if (state.currentRef) {
      setReferenceAndFindSimilar(state.currentRef, scroll);
    } else {
      showToast('Lütfen bir parfüm arayın veya "Beni Şaşırt!" butonunu kullanın.', 'info');
    }
  }

  // --- EVENT HANDLING & INITIALIZATION ---

  /**
   * Sets up carousel functionality.
   * @param {HTMLElement} container - The carousel container element.
   */
  function setupCarousel(container) {
    const windowEl = container.querySelector('.carousel-window');
    const prevBtn = container.querySelector('.carousel-btn.prev');
    const nextBtn = container.querySelector('.carousel-btn.next');
    
    const updateButtons = () => {
      const atStart = windowEl.scrollLeft < 10;
      const atEnd = Math.abs(windowEl.scrollWidth - windowEl.clientWidth - windowEl.scrollLeft) < 10;
      prevBtn.disabled = atStart;
      nextBtn.disabled = atEnd;
    };
    
    on(prevBtn, 'click', () => windowEl.scrollBy({ left: -windowEl.clientWidth * 0.8, behavior: 'smooth' }));
    on(nextBtn, 'click', () => windowEl.scrollBy({ left: windowEl.clientWidth * 0.8, behavior: 'smooth' }));
    on(windowEl, 'scroll', updateButtons, { passive: true });
    new ResizeObserver(updateButtons).observe(windowEl);
    updateButtons();
  }

  /**
   * Attaches all primary event listeners.
   */
  function wireEvents() {
    on(q('.brand'), 'click', () => window.location.href = '/');
    on(q(SELECTORS.searchBtn), 'click', () => findSimilar());
    on(q(SELECTORS.surpriseBtn), 'click', handleSurprise);
    on(q(SELECTORS.signupBtn), 'click', () => showToast('Bu özellik yakında aktif olacak!', 'info'));

    // Search input with debouncing
    const searchInput = q(SELECTORS.searchInput);
    const suggestionsEl = q(SELECTORS.suggestions);
    let debounceTimer;
    on(searchInput, 'input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = searchInput.value.trim();
        if (!query || !state.fuse) { suggestionsEl.style.display = 'none'; return; }
        
        const results = state.fuse.search(query).slice(0, 7);
        if (!results.length) { suggestionsEl.style.display = 'none'; return; }

        suggestionsEl.innerHTML = results.map(r => `
          <div class='suggestion-item' data-index='${r.refIndex}' role="option">
            <img src='${r.item['Image URL'] || 'https://placehold.co/40x40/f3f4f6/6b7280?text=?'}' alt=''/>
            <div class='name'>${r.item.fullName}</div>
            <div class='brand'>${r.item.Brand}</div>
          </div>
        `).join('');
        suggestionsEl.style.display = 'block';
      }, 200);
    });

    on(searchInput, 'keydown', e => { if (e.key === 'Enter') { e.preventDefault(); findSimilar(); suggestionsEl.style.display = 'none'; }});
    on(suggestionsEl, 'click', e => {
        const item = e.target.closest('.suggestion-item');
        if (item) {
            const index = parseInt(item.dataset.index, 10);
            if (!isNaN(index) && state.data[index]) {
                setReferenceAndFindSimilar(state.data[index], true);
            }
            suggestionsEl.style.display = 'none';
        }
    });

    // Hide suggestions on outside click
    on(document, 'click', e => {
      if (!e.target.closest('.search-wrapper')) {
        suggestionsEl.style.display = 'none';
      }
    });

    // FAB scroll-to-top
    const fab = q(SELECTORS.fabTop);
    const toggleFab = () => { fab.classList.toggle('show', window.scrollY > 300); };
    on(window, 'scroll', toggleFab, { passive: true });
    on(fab, 'click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    toggleFab();
  }

  function handleSurprise() {
    if (!state.data.length) return;
    const randomIndex = Math.floor(Math.random() * state.data.length);
    const perfume = state.data[randomIndex];
    setHeroFromPerfume(perfume);
    setReferenceAndFindSimilar(perfume, true);
  }
  
  function setHeroFromPerfume(perfume) {
    const heroImage = q(SELECTORS.heroImage);
    if (perfume['Image URL']) {
      heroImage.src = perfume['Image URL'];
      heroImage.alt = perfume.fullName;
    }
    q(SELECTORS.searchInput).placeholder = `Bir parfüm ara, örn: '${perfume.fullName || 'Aventus'}'`;
  }

  /**
   * Initializes the application.
   */
  async function init() {
    renderPrefToggles();
    wireEvents();
    
    try {
      const response = await fetch('/perfumes_data.json');
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const rawText = await response.text();
      const cleanText = rawText.replace(/:\s*NaN/gi, ': null');
      const data = JSON.parse(cleanText);

      if (!Array.isArray(data) || !data.length) throw new Error('JSON data is invalid or empty.');

      state.data = addFullName(data);
      state.fuse = new Fuse(state.data, {
        includeScore: true,
        threshold: 0.38,
        keys: ['fullName', 'Brand']
      });

      log.info(`${state.data.length} perfumes loaded successfully.`);
      showToast(`✅ ${state.data.length} parfüm başarıyla yüklendi.`, 'ok');
      
      const randomPerfume = state.data[Math.floor(Math.random() * state.data.length)];
      setHeroFromPerfume(randomPerfume);

    } catch (error) {
      log.error('Failed to load initial data:', error);
      showToast('❌ Parfüm verisi yüklenemedi. Lütfen sayfayı yenileyin.', 'error');
      q(SELECTORS.refDetailOut).innerHTML = `
        <div class="placeholder">
          <h4 class="placeholder-title font-serif">Yükleme Başarısız</h4>
          <p class="placeholder-text">'perfumes_data.json' dosyası bulunamadı veya hatalı.</p>
        </div>`;
    }
  }

  // Start the application
  init();

})();
</script>
</body>
</html>
