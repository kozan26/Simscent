<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{TITLE}}</title>
  <meta name="description" content="{{DESCRIPTION}}"/>
  <link rel="canonical" href="{{CANONICAL}}"/>
  <link rel="icon" href="/assets/logo.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/assets/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,500..700,0..1,-50..200"/>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <style>
    :root{--brand-primary:#B99B6B;--brand-secondary:#A08C62;--text:#3a3a3a;--muted:#888;--border:#eee;--card:#fff;--shell:#f9f8f6;--elev-2:0 8px 30px rgba(0,0,0,.07)}
    body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:var(--text);line-height:1.6;background:var(--shell);margin:0}
    .landing{max-width:1200px;margin:28px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:24px;box-shadow:var(--elev-2)}
    .card-inner{padding:28px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;font-size:22px;letter-spacing:-.02em;font-family:'Playfair Display',serif;cursor:pointer}
    .logo{width:32px;height:32px}
    .hero{display:grid;grid-template-columns:1fr;gap:40px;align-items:center;margin-top:20px}
    @media(min-width:980px){.hero{grid-template-columns:420px 1fr;gap:60px}}
    .shot{width:100%;aspect-ratio:1/1;object-fit:cover;padding:16px;background:#fff;border:1px solid var(--border);border-radius:28px;box-shadow:0 28px 70px rgba(0,0,0,.15)}
    .title{font-family:'Playfair Display',serif;font-size:clamp(32px,4.8vw,52px);font-weight:800;letter-spacing:-.04em;line-height:1.05;color:#222;margin:0 0 12px}
    .desc{color:var(--muted)}
    .searchbar{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:12px 16px;margin-top:20px}
    .searchbar input{flex:1;border:none;background:transparent;outline:none;font-size:16px;color:var(--text)}
    .icon-btn{width:44px;height:44px;border-radius:999px;border:none;display:grid;place-items:center;background:var(--text);color:#fff;cursor:pointer}
    .section{padding:32px 0;border-top:1px dashed #e5e7eb}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#f9f8f6;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:600}
    .toast{position:fixed;bottom:24px;left:50%;transform:translate(-50%,16px);background:#111;color:#fff;padding:12px 18px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:9999}
    .toast.show{opacity:1;transform:translate(-50%,0)}
  </style>
</head>
<body>
<main class="landing" id="appRoot">
  <div class="card"><div class="card-inner">
    <div class="brand" onclick="location.href='/'">
      <img class="logo" src="/assets/logo.svg" alt="simscent">simscent
    </div>

    <section class="hero">
      <img id="heroShot" class="shot" src="https://images.unsplash.com/photo-1617839400561-d55457a29da2?q=80&w=930&auto=format&fit=crop" alt="parfüm"/>
      <div>
        <h1 class="title">{{NAME}}</h1>
        <p class="desc">{{BRAND}} {{CONCENTRATION}}</p>

        <div class="searchbar">
          <input id="searchInput" type="text" placeholder="Bir parfüm ara…" autocomplete="off" aria-label="Parfüm ara"/>
          <button id="searchBtn" class="icon-btn" title="Ara" aria-label="Ara">Ara</button>
        </div>
        <div id="suggestions" style="display:none; margin-top:8px;"></div>
      </div>
    </section>

    <section class="section" id="results">
      <div id="refDetailOut"></div>
    </section>

    <section class="section" id="similar" style="display:none">
      <h3>Benzeri Parfümler</h3>
      <div id="similarOut" class="chips"></div>
    </section>
  </div></div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
'use strict';
(function(){
  const q=(s,r=document)=>r.querySelector(s);
  const on=(el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
  function showToast(msg){ const t=q('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.classList.remove('show'),2000); }

  const state={ sidx:null, sidxLoaded:false, data:[], bigLoaded:false, fuse:null };

  async function ensureSearchIndex(){
    if(state.sidxLoaded) return;
    try{ const r=await fetch('/search/index.json'); const j=await r.json(); state.sidx=j.items||[]; }catch{ state.sidx=[]; }
    state.sidxLoaded=true;
  }
  function parseFlexibleJSON(text){
    try{ const o=JSON.parse(text); if(Array.isArray(o)) return o; if(o&&typeof o==='object'&&Array.isArray(o.data)) return o.data; }catch(_){}
    const arr=[]; for(const ln of text.split(/\r?\n/)){ const s=ln.trim(); if(!s) continue; try{ arr.push(JSON.parse(s)); }catch(_){ } }
    if(arr.length) return arr; throw new Error('Invalid JSON');
  }
  function addFullName(arr){
    for(const p of arr){ const name=p['Fragrance Name']||p.name||''; const conc=p.Concentration||p.concentration||''; p.fullName=(conc?(\`\${name} \${conc}\`):name).trim(); }
    return arr;
  }
  async function ensureFullData(){
    if(state.bigLoaded) return;
    showToast('Koleksiyon yükleniyor…');
    const r=await fetch('/perfumes_data.json'); const text=(await r.text()).replace(/:\s*NaN/gi,': null');
    const data=addFullName(parseFlexibleJSON(text));
    state.data=data; state.bigLoaded=true;
    state.fuse=new Fuse(state.data,{includeScore:true,threshold:0.38,ignoreLocation:true,keys:[{name:'fullName',weight:0.6},{name:'Brand',weight:0.35},{name:'Concentration',weight:0.5}]});
  }

  function renderRefDetail(p){
    const out=q('#refDetailOut'); out.innerHTML='';
    const img=p['Image URL']||'https://placehold.co/480x480/e2e8f0/64748b?text='+encodeURIComponent((p.Brand||'?').slice(0,1));
    out.innerHTML=\`
      <div style="display:grid;grid-template-columns:1fr;gap:28px;align-items:start">
        <img src="\${img}" alt="\${p.fullName}" style="width:100%;max-width:320px;border-radius:20px;object-fit:cover"/>
        <div>
          <div style="font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:var(--brand-primary);font-weight:700">\${p.Brand||''}</div>
          <h1 style="font-family:'Playfair Display',serif;font-size:28px;margin:6px 0 0">\${p.fullName||''}</h1>
        </div>
      </div>\`;
    const hero=q('#heroShot'); if(p['Image URL']){ hero.src=p['Image URL']; hero.alt=p.fullName; }
  }
  function similarities(target){
    if(!state.data.length) return [];
    const KEYS={usage:['Daily','Business','Evening','Night Out','Leisure','Sport'],season:['Spring','Summer','Fall','Winter'],style:['Classic','Masculine','Feminine','Modern'],family:['Animal','Aquatic','Chypre','Citrus','Creamy','Earthy','Floral','Fougère','Fresh','Fruity','Gourmand','Green','Leathery','Oriental','Powdery','Resinous','Smoky','Spicy','Sweet','Synthetic','Woody']};
    function vec(a,b,keys){ let dot=0,n1=0,n2=0; for(const k of keys){ const x=+a[k]||0, y=+b[k]||0; dot+=x*y; n1+=x*x; n2+=y*y; } return (!n1||!n2)?0:dot/(Math.sqrt(n1)*Math.sqrt(n2)); }
    const prefs={usage:true,season:true,style:true,family:true};
    return state.data.map(p=>{
      if(p.fullName===target.fullName) return {perfume:p, similarity:-1};
      let s=0,w=0; for(const k in prefs){ if(prefs[k]){ s+=vec(target,p,KEYS[k]); w++; } } const avg=w? s/w : 0; return {perfume:p, similarity: Math.pow(avg,3)};
    }).filter(x=>x.similarity!==-1).sort((a,b)=>b.similarity-a.similarity).slice(0,10);
  }
  function renderSimilar(list){
    const sec=q('#similar'); const out=q('#similarOut'); out.innerHTML='';
    if(!list.length){ sec.style.display='none'; return; }
    sec.style.display='block';
    list.forEach(({perfume:p})=>{
      const img=p['Image URL']||'https://placehold.co/80x80/e2e8f0/64748b?text='+encodeURIComponent((p.Brand||'?').slice(0,1));
      const el=document.createElement('span'); el.className='chip'; el.innerHTML=\`<img src="\${img}" alt="" style="width:18px;height:18px;border-radius:6px;object-fit:cover"> \${p.Brand||''} — <strong>\${p.fullName||''}</strong>\`;
      out.appendChild(el);
    });
  }

  async function bootstrapFromRoute(){
    const m=location.pathname.match(/^\/p\/([^/]+)\/([^/]+)/);
    if(!m) return;
    const slug=decodeURIComponent(m[2]).replace(/-/g,' ').toLowerCase();
    await ensureSearchIndex();
    await ensureFullData();
    const res=state.fuse.search(slug);
    const ref=res?.[0]?.item;
    if(ref){
      renderRefDetail(ref);
      renderSimilar(similarities(ref));
    }else{
      q('#refDetailOut').innerHTML='<p style="color:#888;padding:12px">Ürün verisi bulunamadı.</p>';
    }
  }

  function setupSearch(){
    const input=q('#searchInput'); const btn=q('#searchBtn');
    function debounce(fn,ms=140){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    on(input,'focus', ()=>{ ensureSearchIndex(); }, { once:true });
    on(btn,'click', async ()=>{
      const v=(input.value||'').trim(); if(!v) return;
      await ensureFullData(); const res=state.fuse.search(v); const ref=res?.[0]?.item; if(ref){ renderRefDetail(ref); renderSimilar(similarities(ref)); }
    });
  }

  (function init(){ setupSearch(); bootstrapFromRoute(); })();
})();
</script>

<!-- {{CONTENT}} intentionally left empty by generator -->
</body>
</html>
